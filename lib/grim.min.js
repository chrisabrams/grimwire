function routeMap(e,t,n,o){var i=e.method.toLowerCase();i in n&&(i=n[i]),n._prefix&&(i=n._prefix+toUpperFirst(i));var r=e.path;for(var a in o){var s=makeRouteRegex(a).exec(r);if(s){var c=o[a];Array.isArray(c)&&(i+=toUpperFirst(c[1]),c=c[0]);var l=[e,t].concat(s.slice(1));return i in c?c[i].apply(c,l):t.writeHead(405,"bad method").end()}}t.writeHead(404,"not found").end()}function makeRouteRegex(e){return e=e.replace(/(:[^\/]+)/g,"([^/]+)"),"/"==e.slice(-1)&&(e=e.slice(0,-1)),RegExp("^"+e+"/?$","i")}function toTitleCase(e){return e.replace(/\w\S*/g,function(e){return e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()})}function toUpperFirst(e){return e.charAt(0).toUpperCase()+e.substr(1)}function patch(e,t){if(null===t)return e;e||(e={});for(var n in t)e[n]="object"==typeof e[n]&&"object"==typeof t[n]?patch(e[n],t[n]):t[n];return e}function deepClone(e){return $.extend(!0,{},e)}function attachCookies(e,t){var n={};if(t instanceof local.client.Region){var o=t.cookies[e.urld.authority];if(o)for(var i in o)n[i]=o[i].value||o[i],o[i].query&&(e.query[i]=e.query[i]===void 0?o[i].value:e.query[i])}var r=storageServer.getItem(e.urld.host,".cookies");if(r&&r.items)for(var i in r.items)i in n||(n[i]=r.items[i].value||r.items[i],r.items[i].query&&(e.query[i]=e.query[i]===void 0?r.items[i].value:e.query[i]));e.headers.cookie=n}function updateCookies(e,t,n){var o=n.headers["set-cookie"];if(o){var i=storageServer.getItem(e.urld.host,".cookies")||{id:".cookies",items:{}};i.items&&"object"==typeof i.items||(i.items={});for(var r in o)o[r].scope&&"session"!=o[r].scope||(null===o[r]?delete i.items[r]:i.items[r]=o[r]);storageServer.setItem(e.urld.host,i)}}(function(){function e(e){local.client.Region.call(this,e),this.cookies={}}function t(e){for(var t=0;r>t;t++)if(0===e.indexOf(i[t]))return!0;return!1}function n(e){return e.replace(/(\-?[\d]+)([A-z]*)/g,function(e,t){var n=+t;return 0>n?0:e})}function o(e){e.id||(e.id="client-region-"+a++)}e.prototype=Object.create(local.client.Region.prototype),local.client.GrimRegion=e,e.prototype.hasSameOrigin=function(e){if(!(this.context.urld&&this.context.urld.host&&e.context.urld&&e.context.urld.host))return!1;var t=this.context.urld.host.split(".").slice(-2).join("."),n=e.context.urld.host.split(".").slice(-2).join(".");return t==n},e.prototype.__handleResponse=function(e,t,n){var o=this.element,i=this.__chooseRequestTarget(e,t);if(i){var r=local.env.getClientRegion(i.id);switch(r&&(r.__updateContext(t,n),r.hasSameOrigin(this)&&(o=i)),n.status){case 204:case 304:break;case 205:"FORM"===i.tagName&&i.reset();break;case 302:case 303:var a={method:"get",url:n.headers.location,headers:{accept:"text/html"}};this.dispatchRequest(a);break;default:if(n.headers["content-type"])local.client.renderResponse(i,o,n);else{var s="success";n.status>=400&&(s="info"),n.status>=500&&(s="error"),$.pnotify({title:n.status+" "+n.reason,text:t.method.toUpperCase()+" "+t.url,type:s,styling:"bootstrap"})}}}},e.prototype.__updateContext=function(e,t){local.client.Region.prototype.__updateContext.call(this,e,t);var n=this.context.urld.authority;n in this.cookies||(this.cookies[n]={});var o=t.headers["set-cookie"];if(o)for(var i in o)"client"==o[i].scope&&(null===o[i]?delete this.cookies[n][i]:this.cookies[n][i]=o[i])},e.prototype.__chooseRequestTarget=function(e,t){if("_element"==t.target)return e.target;var n=document.getElementById(t.target);if(n){if(n.dataset.clientRegion){var o=local.env.getClientRegion(n.id);return o?n:(console.error("Element with data-client-region set to 'replace' should be a client region, but isn't. This means Grimwire did something wrong. Dropping response."),null)}return console.error("Request targeted at #"+t.target+", which has no region behavior specified with data-client-region. Dropping response."),null}return this.element},window.clientRegionPostProcess=function(e){$("div[data-client-region]",e).each(function(e,t){o(t);var n=new local.client.GrimRegion(t.id);local.env.addClientRegion(n);var i=t.dataset.clientRegion;i&&n.dispatchRequest(i)}),$("[style]",e).each(function(e,o){for(var i=o.style.length,r=0;i>r;r++){var a=o.style[r];-1!=a.indexOf("padding")||-1!=a.indexOf("margin")?o.style.setProperty(a,n(o.style[a])):0==t(a)&&o.style.removeProperty(a)}})};var i=["color","background","font","line-height","line-spacing","text-align","text-decoration","vertical-align","border","box-shadow","overflow","cursor","width","height","max-width","max-height","white-space"],r=i.length,a=100})(),function(e){function t(e){local.env.Server.call(this),this.storage=e||localStorage,this.collections={}}function n(){return(0|65536*(1+Math.random())).toString(16).substring(1)}function o(){return n()+n()+"-"+n()+"-"+n()+"-"+n()+"-"+n()+n()+n()}function i(e){return RegExp(e.replace(/\:collection/g,"([A-z0-9_\\-\\.]+)").replace(/\:item/g,"([^/]+)"))}function r(){var e={link:[{href:"/",rel:"self current"},{href:"/{title}",rel:"collection"}]};return Object.keys(this.collections).forEach(function(t){e.link.push({href:"/"+t,rel:"collection",title:t})}),e}function a(e){var t={link:[{href:"/",rel:"up via service"}]};return e&&(t.link.push({href:"/"+e,rel:"self current"}),t.link.push({href:"/"+e+"/{title}",rel:"item"})),t}function s(e,t){var n={link:[{href:"/",rel:"via service"}]};return e&&n.link.push({href:"/"+e,rel:"up collection"}),t&&n.link.push({href:"/"+e+"/"+t,rel:"self current"}),n}function c(e,t){var n=r.call(this);/get/i.test(e.method)?(n["content-type"]="application/json",t.writeHead(200,"ok",n).end(this.collections)):t.writeHead(200,"ok",n).end()}function l(e,t){var n;do n=o();while(this.collections[n]!==void 0);this.collections[n]=[];var i=r.call(this);i.location="/"+n,i["content-type"]="application/json",t.writeHead(201,"created",i).end({id:n})}function p(e,t,n){var o=a.call(this,n);/get/i.test(e.method)?(o["content-type"]="application/json",t.writeHead(200,"ok",o).end(this.listCollectionItems(n))):t.writeHead(200,"ok",o).end()}function d(e,t,n){if(!e.body||"object"!=typeof e.body)return t.writeHead(422,"unprocessable entity").end("request body required as a JSON object");this.setItem(n,e.body);var o=a.call(this,n);o.location="/"+n+"/"+e.body.id,o["content-type"]="application/json",t.writeHead(201,"created",o).end({id:e.body.id})}function u(e,t,n){this.removeCollection(n),t.writeHead(204,"no content",a.call(this,n)).end()}function f(e,t,n,o){var i=s.call(this,n,o),r=this.getItem(n,o);r?/get/i.test(e.method)?(i["content-type"]="application/json",t.writeHead(200,"ok",i).end(r)):t.writeHead(200,"ok",i).end():t.writeHead(404,"not found",i).end()}function h(e,t,n,o){return e.body&&"object"==typeof e.body?(e.body.id=o,this.setItem(n,e.body),t.writeHead(204,"no content",s.call(this,n,o)).end(),void 0):t.writeHead(422,"unprocessable entity").end("request body required as a JSON object")}function v(e,t,n,o){if(!e.body||"object"!=typeof e.body)return t.writeHead(422,"unprocessable entity").end("request body required as a JSON object");var i=this.getItem(n,o);i?(i=m(i,e.body),this.setItem(n,i),t.writeHead(204,"no content",s.call(this,n,o)).end()):t.writeHead(404,"not found",s.call(this,n,o)).end()}function g(e,t,n,o){this.removeItem(n,o),t.writeHead(204,"no content",s.call(this,n,o)).end()}function m(e,t){if(null===t)return null;null===e&&(e={});for(var n in t)e[n]="object"==typeof e[n]&&"object"==typeof t[n]?m(e[n],t[n]):t[n];return e}t.prototype=Object.create(local.env.Server.prototype),t.prototype.handleHttpRequest=function(e,t){function n(n,a,s){if(!o)if(n&&a){if(a=i(a),a.test(e.path)&&RegExp("^"+n+"$","i").test(e.method)){o=!0;var c=a.exec(e.path),l=[e,t].concat(c.slice(1));s.apply(r,l)}}else t.writeHead(404,"not found").end()}var o=!1,r=this;n("HEAD","^/?$",c),n("GET","^/?$",c),n("POST","^/?$",l),n("HEAD","^/:collection/?$",p),n("GET","^/:collection/?$",p),n("POST","^/:collection/?$",d),n("DELETE","^/:collection/?$",u),n("HEAD","^/:collection/:item/?$",f),n("GET","^/:collection/:item/?$",f),n("PUT","^/:collection/:item/?$",h),n("PATCH","^/:collection/:item/?$",v),n("DELETE","^/:collection/:item/?$",g),n()},t.prototype.getCollection=function(e){if(!this.collections[e]){var t=this.storage.getItem(e);this.collections[e]=t?t.split(","):[]}return this.collections[e]},t.prototype.saveCollection=function(e){this.collections[e]&&this.storage.setItem(e,this.collections[e].join(","))},t.prototype.removeCollection=function(e){this.collections[e]&&(this.collections[e].forEach(function(t){this.storage.removeItem(e+"|"+t)},this),this.storage.removeItem(e),delete this.collections[e])},t.prototype.listCollectionItems=function(e){var t=this.getCollection(e);return t.map(function(t){return this.getItem(e,t)},this).filter(function(e){return null!==e})},t.prototype.getItem=function(e,t){try{return JSON.parse(this.storage.getItem(e+"|"+t))}catch(n){return null}},t.prototype.setItem=function(e,t){t.id||(t.id=o()),this.storage.setItem(e+"|"+t.id,JSON.stringify(t));var n=this.getCollection(e);-1===n.indexOf(""+t.id)&&(n.push(""+t.id),this.saveCollection(e))},t.prototype.removeItem=function(e,t){var n=this.getCollection(e);this.collections[e]=n.filter(function(e){return t!=e}),this.saveCollection(e),this.storage.removeItem(e+"|"+t)},e.StorageServer=t}(window),function(e){function t(e){local.env.Server.call(this),this.storageHost=e,this.storageHost.apps=e.collection("apps"),this.storageHost.workerCfgs=e.collection("workercfgs"),this.hostEnvConfig={},this.hostAppConfigs={},this.activeAppId=null,this.openAppIds=["_apps"],this.defaultAppId=null,this.hostAppConfigs._apps={id:"_apps",title:"Applications",startpage:"httpl://config.env/apps"},this.broadcasts={apps:local.http.broadcaster(),activeApp:local.http.broadcaster()}}function n(e){return function(t,n,o){".active"==o&&(o=this.activeAppId);var i=this;this.getAppConfig(o).then(function(r){i.setAppEnabled(o,e),e?i.openApp(o):i.closeApp(o),i.broadcastOpenApps(),r._active=e,/html/.test(t.headers.accept)?n.writeHead(200,"ok",{"content-type":"text/html"}).end(c.appCfg(r,r,null,null)):n.writeHead(200,"ok").end()},function(){n.writeHead(404,"not found").end()})}}function o(e){var t={};return e?(e.id||(t.id="required"),e.startpage||(t.startpage="required"),("object"!=typeof e.common||Array.isArray(e.common))&&(t.common="must be an object"),e.workers||(t.workers="required"),Array.isArray(e.workers)&&e.workers.length||(t.workers="must be an array with at least 1 member"),Object.keys(t).length>0?t:null):{_body:"required"}}function i(e){var t={};return e?(e.title||(t.title="required"),e.id||(t.id="required"),e.src||(t.src="required"),Object.keys(t).length>0?t:null):{_body:"required"}}function r(e,t){t.common&&"object"==typeof t.common&&patch(e,t.common),e.appId=t.id,e.appTitle=t.title,e.appIcon=t.icon,e.domain=a(e,t)}function a(e,t){return t&&"object"==typeof t?t=t.id:!t&&e&&"object"==typeof e&&(t=e.appId),e&&"object"==typeof e&&(e=e.id),e+"."+t+".usr"}function s(e,t){return local.http.unregisterLocal(e.config.domain),e.terminate(),e=local.env.servers[t.domain]=new local.env.WorkerServer(t),e.loadUserScript(),local.http.registerLocal(t.domain,e.handleHttpRequest,e),e}t.prototype=Object.create(local.env.Server.prototype),t.prototype.handleHttpRequest=function(e,t){routeMap(e,t,{_prefix:"http",head:"get",patch:"set",put:"set",post:"addTo"},{"/":[this,"Service"],"/workers":[this,"Workers"],"/workers/:domain":[this,"Worker"],"/workers/:domain/src":[this,"WorkerSource"],"/apps":[this,"Apps"],"/apps/:id":[this,"App"]})},t.prototype.loadFromHost=function(e){e=e||".host.json";var t=this;return local.http.navigator(e).getJson().succeed(function(e){t.hostEnvConfig=e.body,"string"==typeof t.hostEnvConfig&&(t.hostEnvConfig=JSON.parse(t.hostEnvConfig));var n=t.hostEnvConfig.applications.map(function(e){return local.http.navigator(e).getJson()});return local.promise.bundle(n)}).succeed(function(e){return e.forEach(function(e){e.body&&("string"==typeof e.body&&(e.body=JSON.parse(e.body)),e.body.id||console.error("Invalid application config: `id` is required",e.body),t.hostAppConfigs[e.body.id]=e.body)}),t.getAppConfigs()})},t.prototype.openApp=function(e){var t=this;return this.getAppConfig(e).succeed(function(n){if(n.id&&"_"!==n.id.charAt(0)){var a=o(n);if(a)throw"Invalid application config for '"+e+"': "+JSON.stringify(a)}if(-1!==t.openAppIds.indexOf(e))return n;if(t.openAppIds.push(e),Array.isArray(n.workers)){var s=[];return n.workers.forEach(function(e){e=deepClone(e);var o=i(e);return o?console.error("Invalid worker config:",o,e):(r(e,n),s.push(t.getWorkerUserConfig(e.domain).succeed(function(t){e.usr=t,local.env.addServer(e.domain,new local.env.WorkerServer(e))})),void 0)}),local.promise.bundle(s).then(function(){return n})}return n})},t.prototype.closeApp=function(e){var t=this;return this.getAppConfig(e).succeed(function(n){var o=t.openAppIds.indexOf(e);return-1===o?n:(t.openAppIds.splice(o,1),Array.isArray(n.workers)&&n.workers.forEach(function(t){var n=local.env.servers[a(t,e)];n instanceof local.env.WorkerServer&&local.env.killServer(n.config.domain)}),n)})},t.prototype.reloadApp=function(e){this.closeApp(e),this.openApp(e)},t.prototype.setActiveApp=function(e){var t=this;e||(e=this.defaultAppId),this.getAppConfig(e).then(function(n){t.activeAppId=e,t.broadcasts.activeApp.emit("update",n)},function(){console.error('Failed to set active app to "'+e+'": not found')})},t.prototype.setAppEnabled=function(e,t){var n=this;return this.getEnvConfig().succeed(function(o){o.disabled&&Array.isArray(o.disabled)||(o.disabled=[]);var i=o.disabled.indexOf(e);return t?-1!==i&&o.disabled.splice(i,1):-1===i&&o.disabled.push(e),n.setEnvConfig(o)})},t.prototype.enableApp=function(e){return this.setAppEnabled(e,!0)},t.prototype.disableApp=function(e){return this.setAppEnabled(e,!1)},t.prototype.openEnabledApps=function(){var e,t=this;return this.getEnvConfig().succeed(function(n){return e=n,e.disabled&&Array.isArray(e.disabled)||(e.disabled=[]),t.getAppIds()}).succeed(function(n){var o=[];return n.forEach(function(n){"_"!=n.charAt(0)&&".host"!=n&&-1===e.disabled.indexOf(n)&&(t.defaultAppId||(t.defaultAppId=n),o.push(t.openApp(n)))}),local.promise.bundle(o)})},t.prototype.getEnvConfig=function(){var e=this;return this.storageHost.apps.item(".host").getJson().then(function(e){return e.body},function(){return deepClone(e.hostEnvConfig)}).succeed(function(e){return e.disabled&&Array.isArray(e.disabled)||(e.disabled=[]),e})},t.prototype.setEnvConfig=function(e){return this.storageHost.apps.item(".host").put(e,"application/json")},t.prototype.getAppIds=function(){var e=this,t=Object.keys(e.hostAppConfigs);return this.storageHost.apps.getJson().succeed(function(e){var n=e.body;return n&&n.length>0?t.concat(n.map(function(e){return e.id})):t}).fail(function(){return t})},t.prototype.getOpenAppIds=function(){var e,t=this;return this.getEnvConfig().succeed(function(n){return e=n,t.getAppIds()}).succeed(function(t){return t.filter(function(t){return-1===e.disabled.indexOf(t)})})},t.prototype.getAppConfigs=function(){var e=this,t=deepClone(this.hostAppConfigs);for(var n in t)t[n]._readonly=!0;return this.storageHost.apps.getJson().then(function(e){return e.body||[]},function(){return[]}).succeed(function(e){return e.forEach(function(e){".host"!=e.id&&(t[e.id]=e)}),t}).succeed(function(t){for(var n in t)t[n]._active=-1!==e.openAppIds.indexOf(n);return t})},t.prototype.getOpenAppConfigs=function(){var e,t=this;return this.getAppConfigs().succeed(function(n){return e=n,t.getEnvConfig()}).succeed(function(t){return t.disabled.forEach(function(t){t in e&&delete e[t]}),e})},t.prototype.getAppConfig=function(e){var t;t=e&&"object"==typeof e?local.promise(deepClone(e)):e in this.hostAppConfigs?local.promise(patch(deepClone(this.hostAppConfigs[e]),{_readonly:!0})):this.storageHost.apps.item(e).getJson().succeed(function(e){return e.body});var n=this;return t.succeed(function(e){return e._active=-1!==n.openAppIds.indexOf(e.id),e})},t.prototype.loadUserApp=function(e){var t=this;return this.getAppConfig(e.id).succeed(function(){return e.id=(""+e.id).replace(/(\d+)?$/,function(e){return(+e||1)+1}),e.startpage&&(e.startpage=e.startpage.replace(/\.([^\/]*)\.usr/,"."+e.id+".usr")),t.loadUserApp(e)}).fail(function(){for(var n in e)"_"==n.charAt(0)&&delete e[n];return t.storageHost.apps.item(e.id).put(e,"application/json").succeed(function(){t.broadcastOpenApps()})})},t.prototype.unloadUserApp=function(e){e&&"object"==typeof e&&(e=e.id);var t=this;return this.storageHost.apps.item(e).delete().succeed(function(){return t.broadcastOpenApps(),t.getEnvConfig()}).succeed(function(n){var o=n.disabled.indexOf(e);return-1!==e&&n.disabled.splice(o,1),t.setEnvConfig(n)})},t.prototype.getWorkerUserConfig=function(e){return this.storageHost.workerCfgs.item(e).getJson().then(function(e){return e.body},function(){return{}})},t.prototype.broadcastOpenApps=function(){var e=this;e.getOpenAppConfigs().then(function(t){e.broadcasts.apps.emit("update",t)})},t.prototype.httpGetService=function(e,t){var n={link:[{rel:"self",href:"/"},{rel:"collection",href:"/apps",title:"apps"},{rel:"collection",href:"/{title}"}]};/html/.test(e.headers.accept)?t.writeHead(501,"not implemented").end():/head/i.test(e.method)?t.writeHead(200,"ok",n).end():t.writeHead(406,"not acceptable").end()},t.prototype.httpGetWorkers=function(e,t){/html/.test(e.headers.accept)?t.writeHead(501,"not implemented").end():t.writeHead(406,"not acceptable").end()},t.prototype.httpGetWorker=function(e,t,n){var o={link:[{rel:"via service",href:"/"},{rel:"up",href:"/workers"},{rel:"self",href:"/workers/"+n}]},i=local.env.servers[n];return i?(/html/.test(e.headers.accept)?(o["content-type"]="text/html",t.writeHead(200,"ok",o).end(c.workerCfg(i.config))):t.writeHead(406,"bad accept type").end(),void 0):t.writeHead(404,"not found").end()},t.prototype.httpSetWorker=function(e,t,n){var o=local.env.servers[n];if(!o)return t.writeHead(404,"not found").end();if(/json|form/.test(e.headers["content-type"])){var i=this;this.getWorkerUserConfig(n).succeed(function(r){var a=o.config;r=/PATCH/i.test(e.method)?patch(r,e.body):e.body,a.usr=r,i.storageHost.workerCfgs.item(n).put(r),s(o,a),t.writeHead(204,"no content").end()})}else t.writeHead(415,"bad content type").end()},t.prototype.httpGetWorkerSource=function(e,t,n){var o={link:[{rel:"via service",href:"/"},{rel:"up",href:"/workers/"+n},{rel:"self",href:"/workers/"+n+"/src"}]},i=local.env.servers[n];return i?(/html/.test(e.headers.accept)?(o["content-type"]="text/html",this.getAppConfig(i.config.appId).then(function(e){i.getSource().then(function(n){t.writeHead(200,"ok",o).end(c.workerSource(i.config,n,e))})})):t.writeHead(406,"bad accept type").end(),void 0):t.writeHead(404,"not found").end()},t.prototype.httpSetWorkerSource=function(e,t,n){var o=local.env.servers[n];if(!o)return t.writeHead(404,"not found").end();if(/json|form/.test(e.headers["content-type"])){var i=this,r=o.config.appId;this.getAppConfig(r).succeed(function(n){var a=e.body.src;if(!a)return t.writeHead(422,"request errors").end();/^http/.test(a)===!1&&(a="data:application/javascript,"+a);for(var c,l=0;n.workers.length>l;l++)if(n.workers[l].id==o.config.id){c=n.workers[l];break}return c?(c.src=a,i.storageHost.apps.item(r).put(n,"application/json"),o.config.src=a,s(o,o.config),t.writeHead(200,"ok").end(),void 0):t.writeHead(404,"not found").end()})}else t.writeHead(415,"bad content type").end()},t.prototype.httpGetApps=function(e,t){var n={link:[{rel:"up via service",href:"/"},{rel:"self",href:"/apps"},{rel:"item",href:"/apps/{title}"},{rel:"http://grimwire.com/rel/index",href:"/apps?schema=grimsearch"}]};if(/event-stream/.test(e.headers.accept))n["content-type"]="text/event-stream",t.writeHead(200,"ok",n),this.broadcasts.apps.addStream(t);else if(/json/.test(e.headers.accept))n["content-type"]="application/json",this.getAppConfigs().then(function(o){if("grimsearch"==e.query.schema){var i=[];for(var r in o)"_"!=r.charAt(0)&&i.push({icon:"hand-right",category:"Applications",title:o[r].title,desc:o[r]._readonly?"Host Application":"User Application",href:"#"+r});t.writeHead(200,"ok",n).end(i)}else t.writeHead(200,"ok",n).end(o)},function(){t.writeHead(500).end()});else if(/html/.test(e.headers.accept)){n["content-type"]="text/html";var o=e.query.view;this.getAppConfigs().succeed(function(i){var r;r="summary"==o?c.appsSummary(i,e.query.inner):"sidenav"==o?c.appsSidenav(i,e.query.selection):c.appsMain(i),n["content-type"]="text/html",t.writeHead(200,"ok",n).end(r)}).fail(function(){t.writeHead(500,"internal error").end()})}else/head/i.test(e.method)?t.writeHead(200,"ok",n).end():t.writeHead(406,"not acceptable").end()},t.prototype.httpAddToApps=function(e,t){var n={link:[{rel:"up via service",href:"/"},{rel:"self",href:"/apps"},{rel:"item",href:"/apps/{title}"}]},i=function(n){return/html/.test(e.headers.accept)?t.writeHead(422,"request errors",{"content-type":"text/html"}).end(c.appLoadNew(n)):t.writeHead(422,"request errors").end(n)};if(!e.body||!e.body.config)return i({config:"Required."});var r=e.body.config.content;if("string"==typeof r&&0===r.indexOf("data:")){if(0!==r.indexOf("data:application/json"))return i({config:"Invalid file-type - must be JSON."});if(r=atob(r.split(",")[1]),!r)return i({config:"Invalid file-type - must be JSON."});try{r=JSON.parse(r)}catch(a){return i({config:"Failed parsing JSON - "+a.message})}}var s=o(r);if(s)return i({config:s});var l=this;this.loadUserApp(r).then(function(){l.openApp(r.id),/html/.test(e.headers.accept)?(n["content-type"]="text/html",l.getAppConfigs().succeed(function(e){t.writeHead(201,"created",n),t.end(c.appsSummary(e))})):t.writeHead(201,"created",n).end()},function(){t.writeHead(500,"internal error").end()})},t.prototype.httpGetApp=function(e,t,n){var o={link:[{rel:"via service",href:"/"},{rel:"up",href:"/apps"},{rel:"self",href:"/apps/"+n}]};if(".active"==n){if(/event-stream/.test(e.headers.accept))return o["content-type"]="text/event-stream",t.writeHead(200,"ok",o),this.broadcasts.activeApp.addStream(t),void 0;n=this.activeAppId}return".new"==n?/html/.test(e.headers.accept)?(o["content-type"]="text/html",t.writeHead(200,"ok",o).end(c.appLoadNew())):t.writeHead(406,"not acceptable").end():(/json/.test(e.headers.accept)?(o["content-type"]="application/json",this.getAppConfig(n).then(function(e){t.writeHead(200,"ok",o).end(e)},function(){t.writeHead(404,"not found").end()})):/html/.test(e.headers.accept)?(o["content-type"]="text/html",this.getAppConfig(n).then(function(e){t.writeHead(200,"ok",o).end(c.appCfg(e,e,null,null))},function(){t.writeHead(404,"not found",o).end('<h2 class="muted">App Not Found</h2>')})):/head/i.test(e.method)?t.writeHead(200,"ok",o).end():t.writeHead(406,"not acceptable").end(),void 0)},t.prototype.httpDuplicateApp=function(e,t,n){".active"==n&&(n=this.activeAppId);var o=this;this.getAppConfig(n).then(function(n){o.loadUserApp(n).then(function(){o.openApp(n.id),/html/.test(e.headers.accept)?t.writeHead(201,"created",{"content-type":"text/html"}).end(c.appCfg(n,n,null,null)):t.writeHead(201,"created").end()},function(){t.writeHead(500,"internal error").end()})},function(){t.writeHead(404,"not found").end()})},t.prototype.httpDeleteApp=function(e,t,n){var o={link:[{rel:"via service",href:"/"},{rel:"up",href:"/apps"},{rel:"self",href:"/apps/"+n}]};".active"==n&&(n=this.activeAppId);var i=this;this.getAppConfig(n).then(function(r){return r._readonly?t.writeHead(403,"forbidden").end():(i.closeApp(n),i.unloadUserApp(n),/html/.test(e.headers.accept)?i.getAppConfigs().succeed(function(e){o["content-type"]="text/html",t.writeHead(200,"ok",o).end(c.appsSummary(e))}):t.writeHead(200,"ok",o).end(),void 0)},function(){t.writeHead(404,"not found").end()})},t.prototype.httpEnableApp=n(!0),t.prototype.httpDisableApp=n(!1),t.prototype.httpDownloadApp=function(e,t){t.writeHead(501,"not implemented").end()},t.prototype.httpAddToApp=function(e,t,n){if(".active"==n&&(n=this.activeAppId),/form/.test(e.headers["content-type"])){var i=this;this.getAppConfig(n).then(function(r){if(r._readonly)return t.writeHead(403,"forbidden").end();var a=e.body,s={};try{a.common||(a.common="{}"),a.common=JSON.parse(a.common)}catch(l){s.common="Unable to parse JSON -"+l}try{a.workers=JSON.parse(a.workers)}catch(l){s.workers="Unable to parse JSON -"+l}0===Object.keys(s).length&&(s=null);var p=patch(o(a),s);return p?t.writeHead(422,"request errors",{"content-type":"text/html"}).end(c.appCfg(r,a,p)):(i.storageHost.apps.item(n).put(a,"application/json").then(function(){i.reloadApp(n),i.broadcastOpenApps(),t.writeHead(200,"ok",{"content-type":"text/html"}).end(c.appCfg(r,a,null,'<i class="icon-ok"></i> <strong>Updated!</strong>'))},function(){t.writeHead(502,"bad gateway",{"content-type":"text/html"}).end(c.appCfg(r,e.body.config,{_body:"Failed to save update"}))}),void 0)})}else t.writeHead(415,"bad content-type").end()};var c={appsMain:function(e,t){var n='<div class="row-fluid"><div class="well well-small span2" style="padding:9px 0"><form style="margin:0" data-subscribe="httpl://config.env/apps?view=sidenav">'+c.appsSidenav(e,t)+"</form></div>"+'<div id="cfgappsmain" class="span10" data-client-region="httpl://config.env/apps?view=summary"></div>'+"</div>";return n},appsSidenav:function(e,t){t=t||"",Object.keys(e).join(",");var n='<input type="hidden" name="selection" data-value-valueof=".active" value="'+t+'">'+'<ul class="nav nav-list">';n+='<li class="'+(t&&"undefined"!=t?"":"active")+'"><a href="httpl://config.env/apps?view=summary" target="cfgappsmain" data-toggle="nav"><strong>Applications</strong></a></li>';for(var o in e){var i=e[o];i.workers&&(n+=c._appsSidenavItem(i,t))}return n+="</ul>"},_appsSidenavItem:function(e,t){var n=t==e.id?" active":"",o='<li class="nav-header'+n+'" value="'+e.id+'">'+'<a href="httpl://config.env/apps/'+e.id+'" target="cfgappsmain" data-toggle="nav"><i class="icon-'+e.icon+'"></i> '+e.title+"</a></li>"+"</li>";return e._active&&(o+=e.workers.map(function(n){var o=a(n,e.id),i="httpl://config.env/workers/"+o,r=t==o?'class="active"':"";return"<li "+r+' value="'+o+'"><a href="'+i+'" target="cfgappsmain" data-toggle="nav">'+n.title+"</a></li>"}).join("")),o},appsSummary:function(e,t){var n="";t||(n+='<div data-subscribe="httpl://config.env/apps?view=summary&inner=1">'),n+="<h4>Applications on "+toUpperFirst(window.location.host)+"</h4><hr/>";for(var o in e)"_"!=o.charAt(0)&&e[o]._readonly&&(n+=c._appHeader(e[o],{nohtml:!0})+"<hr/>");n+='<br/><br/><h4>Your Applications <small><a href="httpl://config.env/apps/.new"><i class="icon-download-alt"></i> Load New App</a></small></h4><hr/>';var i=!1;for(var o in e)"_"!=o.charAt(0)&&(e[o]._readonly||(n+=c._appHeader(e[o],{nohtml:!0})+"<hr/>",i=!0));return i||(n+="<p class=muted>Nothing yet!</p>"),t||(n+="</div>"),n},appCfg:function(e,t,n,o){n=n||{},o=o?'<div class="alert alert-success" data-lifespan="5">'+o+"</div>":"";var i=("string"==typeof t.common?t.common:JSON.stringify(t.common,null,4)).replace(/</g,"&lt;").replace(/>/g,"&gt;"),r=("string"==typeof t.workers?t.workers:JSON.stringify(t.workers,null,4)).replace(/</g,"&lt;").replace(/>/g,"&gt;");return c._appHeader(e)+"<hr/>"+(e._readonly?'<div class="alert alert-info"><i class="icon-info-sign"></i> Host applications are read-only. Click "Copy to Your Applications" to make changes.</div>':"")+'<form class="form-horizontal" action="httpl://config.env/apps/'+e.id+'" method="post">'+o+(n._body?'<div class="alert alert-error">'+n._body+"</div>":"")+'<input type="hidden" name="id" value="'+e.id+'" />'+c._formControl("title","Title","text",t.title,n.title,{readonly:e._readonly,required:!0})+c._formControl("icon","Icon","text",t.icon,n.icon,{readonly:e._readonly,required:!0,help:'via <a href="http://twitter.github.io/bootstrap/base-css.html#icons" target="_blank">Glyphicons</a>'})+c._formControl("startpage","Startpage","url",t.startpage,n.startpage,{width:"span6",required:!0,readonly:e._readonly})+c._formControl("common","Common Config","textarea",i,n.common,{width:"span6",readonly:e._readonly,help:"^ Settings given to every worker"})+c._formControl("workers","Workers","textarea",r,n.workers,{width:"span6",rows:15,required:!0,readonly:e._readonly})+(e._readonly?"":'<div class="control-group"><div class="controls"><button class="btn">Update</button></div></div>')+"</form>"},appLoadNew:function(e){var t="";if(e)if("string"==typeof e.config)t='<div class="alert alert-error">Application file: '+e.config+"</div>";else{t='<div class="alert alert-error"><strong>Mistakes were found in the application file:</strong><br/><ul>';for(var n in e.config)t+="<li>`"+n+"`: "+e.config[n]+"</li>";t+="</ul></div>"}var o='<h2>Load New Application</h2><hr/><form action="httpl://config.env/apps" method="post">'+t+'<input type="file" name="config" required />'+'<button class="btn"><i class="icon-ok"></i> Load</button>'+"</form>";return o},workerCfg:function(e){return"<h3>"+e.domain+"</h3>"+'<ul class="nav nav-tabs">'+'<li class="active"><a target="cfg-'+e.domain+'" href="httpl://'+e.domain+'/.grim/config" title="Configure" data-toggle="nav"><i class="icon-cog"></i></a></li>'+'<li><a target="cfg-'+e.domain+'" href="httpl://config.env/workers/'+e.domain+'/src" title="Edit Source" data-toggle="nav"><i class="icon-edit"></i></a></li>'+'<li><a target="cfg-'+e.domain+'" href="httpl://'+e.domain+'/" title="Execute" data-toggle="nav"><i class="icon-hand-right"></i></a></li>'+"</ul>"+'<div id="cfg-'+e.domain+'" data-client-region="httpl://'+e.domain+'/.grim/config"></div>'+"<hr/>"},workerSource:function(e,t,n){var o=n._readonly?"readonly":"";return'<form action="httpl://config.env/workers/'+e.domain+'/src" method="patch">'+(n._readonly?'<div class="alert alert-info"><i class="icon-info-sign"></i> Host applications are read-only. Copy the app to Your Applications to edit the worker source.</div>':"")+'<textarea name="src" class="span10" rows="20" '+o+">"+t.replace(/</g,"&lt;").replace(/>/g,"&gt;")+"</textarea><br/>"+'<button class="btn">Update</button>'+"</form>"},_appHeader:function(e,t){t=t||{};var n=e._active?"":"muted",o=e._active?"":'<span class="label">inactive</span>',i=t.nohtml?'accept="none"':'accept="text/html"',r='<h2 class="'+n+'"><i class="icon-'+e.icon+'"></i> '+e.title+" <small>*."+e.id+".usr</small> "+o+"</h2>";return r+='<form action="httpl://config.env/apps/'+e.id+'" '+i+">",r+=e._readonly?'<ul class="inline"><li><button class="btn btn-link" formmethod="download"><i class="icon-download"></i> Save as File</button></li><li><button class="btn btn-link" formmethod="duplicate" formaccept="none"><i class="icon-download-alt"></i> Copy to Your Applications</button></li>'+(e._active?'<li><button class="btn btn-link" formmethod="disable"><i class="icon-remove"></i> Disable</button></li>':'<li><button class="btn btn-link" formmethod="enable"><i class="icon-plus"></i> Enable</button></li>')+"</ul>":'<ul class="inline"><li><button class="btn btn-link" formmethod="download"><i class="icon-download"></i> Save as File</button></li><li><button class="btn btn-link" formmethod="duplicate" formaccept="none"><i class="icon-download-alt"></i> Duplicate</button></li><li><button class="btn btn-link" formmethod="delete"><i class="icon-remove-sign"></i> Unload</button></li>'+(e._active?'<li><button class="btn btn-link" formmethod="disable"><i class="icon-remove"></i> Disable</button></li>':'<li><button class="btn btn-link" formmethod="enable"><i class="icon-plus"></i> Enable</button></li>')+"</ul>",r+="</form>"},_formControl:function(e,t,n,o,i,r){r=r||{};var a=[];a.push(r.width||"input-large"),a=a.join(" ");var s=r.readonly?"readonly":"",c=r.required?"required":"",l=s+" "+c;if("textarea"==n){var p=r.rows||5;return'<div class="control-group '+(i?"error":"")+'">'+'<label class="control-label" for="'+e+'">'+t+"</label>"+'<div class="controls">'+'<textarea id="'+e+'" name="'+e+'" class="'+a+'" rows="'+p+'" '+l+">"+o+"</textarea>"+(i||r.help?'<span class="help-block">'+(i||r.help)+"</span>":"")+"</div>"+"</div>"}return'<div class="control-group '+(i?"error":"")+'">'+'<label class="control-label" for="'+e+'">'+t+"</label>"+'<div class="controls">'+'<input type="'+n+'" id="'+e+'" name="'+e+'" class="'+a+'" placeholder="'+t+'" '+l+' value="'+o+'">'+(i||r.help?'<span class="help-inline">'+(i||r.help)+"</span>":"")+"</div>"+"</div>"
}};e.ConfigServer=t}(window);var grimWidgets={};(function(){grimWidgets.lifespan=function(e){for(var t=e.querySelectorAll("[data-lifespan]"),n=0;t.length>n;n++)(function(e){setTimeout(function(){e&&e.parentNode.removeChild(e)},1e3*e.dataset.lifespan)})(t[n])},grimWidgets.value_of=function(e,t){$("[data-value-valueof]",e).each(function(e,n){$(t).on("request",function(){if(n){var e=$(n.dataset.valueValueof,t);n.value="INPUT"==e.tagName||"TEXTAREA"==e.tagName?e.val():e.attr("value")}})}),$("[data-value-idof]",e).each(function(e,n){$(t).on("request",function(){n&&(n.value=$(n.dataset.valueIdof,t).getAttribute("id"))})}),$("[data-value-classof]",e).each(function(e,n){$(t).on("request",function(){n&&(n.value=$(n.dataset.valueClassof,t).attr("class"))})})}})();