(function(){function t(t){return t&&"function"==typeof t.then}function e(t){this.succeedCBs=[],this.failCBs=[],this.__hasValue=!1,this.__hasFailed=!1,this.value=void 0,t&&this.fulfill(t)}function r(e,r,n){if(null===n)e.isRejected()?r.reject(e.value):r.fulfill(e.value);else{var o;try{o=n(e.value)}catch(i){i instanceof Error&&(console.error?console.error(i,i.stack):console.log("Promise exception thrown",i,i.stack)),r.reject(i)}t(o)?s(o).chain(r):r.fulfill(o)}}function n(t,e){Array.isArray(t)||(t=[t]);var r=s(),n=t.length,o=0;if(0===n)return r.fulfill([]),r;var i=[];i.length=n;for(var a=[],l=function(t,s,l){i[s]=t,l&&a.push(s),++o==n&&(e?e(i,a)?r.fulfill(i):r.reject(i):r.fulfill(i))},c=0;n>c;c++)s(t[c]).succeed(l,c,!1).fail(l,c,!0);return r}function o(t){return n(t,function(t,e){return 0===e.length})}function i(t){return n(t,function(t,e){return e.length<t.length})}function s(r){if(arguments.length>1)return n(Array.prototype.slice.call(arguments));if(r instanceof e)return r;if(t(r)){var o=s();return r.then(function(t){o.fulfill(t)},function(t){o.reject(t)}),o}return new e(r)}var a=this;"undefined"!=typeof window?(window.local===void 0&&(window.local={}),a=window.local):"undefined"!=typeof self?(self.local===void 0&&(self.local={}),a=self.local):"undefined"!=typeof module&&(a=module.exports),e.prototype.isUnfulfilled=function(){return!this.__hasValue},e.prototype.isRejected=function(){return this.__hasFailed},e.prototype.isFulfilled=function(){return this.__hasValue&&!this.__hasFailed},e.prototype.then=function(t,e){t=t&&"function"==typeof t?t:null,e=e&&"function"==typeof e?e:null;var n=s();if(this.isUnfulfilled())this.succeedCBs.push({p:n,fn:t}),this.failCBs.push({p:n,fn:e});else{var o=this;setTimeout(function(){o.isFulfilled()?r(o,n,t):r(o,n,e)},0)}return n},e.prototype.succeed=function(t){if(this.isRejected())return this;var e=Array.prototype.slice.call(arguments,1);return this.then(function(r){return t.apply(null,[r].concat(e))})},e.prototype.fail=function(t){if(this.isFulfilled())return this;var e=Array.prototype.slice.call(arguments,1);return this.then(null,function(r){return t.apply(null,[r].concat(e))})},e.prototype.always=function(t){return this.then(t,t)},e.prototype.fulfill=function(t){if(this.isUnfulfilled()){this.value=t,this.__hasValue=!0;for(var e=0;this.succeedCBs.length>e;e++){var n=this.succeedCBs[e];r(this,n.p,n.fn)}this.succeedCBs.length=0,this.failCBs.length=0}return this},e.prototype.reject=function(t){if(this.isUnfulfilled()){this.value=t,this.__hasValue=!0,this.__hasFailed=!0;for(var e=0;this.failCBs.length>e;e++){var n=this.failCBs[e];r(this,n.p,n.fn)}this.succeedCBs.length=0,this.failCBs.length=0}return this},e.prototype.cancel=function(){var t;for(t=0;this.succeedCBs.length>t;t++)this.succeedCBs[t].p.cancel();for(t=0;this.failCBs.length>t;t++)this.failCBs[t].p.cancel();return this.succeedCBs.length=0,this.failCBs.length=0,this},e.prototype.chain=function(t){return this.then(function(e){return s(t).fulfill(e),e},function(e){return s(t).reject(e),e}),t},e.prototype.cb=function(t,e){t?this.reject(t):this.fulfill(e===void 0?null:e)},a.Promise=e,a.promise=s,a.promise.bundle=n,a.promise.all=o,a.promise.any=i})(),"undefined"!=typeof define&&define([],function(){return Promise}),this.local===void 0&&(this.local={}),this.local.util===void 0&&(this.local.util={}),function(){function t(){Object.defineProperty(this,"_events",{value:{},configurable:!0,enumerable:!1})}t.prototype.emit=function(t){var e=this._events[t];if(!e)return!1;for(var r=Array.prototype.slice.call(arguments,1),n=0,o=e.length;o>n;n++)e[n].apply(this,r);return!0},t.prototype.addListener=function(t,e){if(Array.isArray(t))return t.forEach(function(t){this.addListener(t,e)},this),void 0;if("function"!=typeof e)throw Error("addListener only takes instances of Function");return this.emit("newListener",t,e),this._events[t]?this._events[t].push(e):this._events[t]=[e],this},t.prototype.on=t.prototype.addListener,t.prototype.once=function(t,e){var r=this;r.on(t,function n(){r.removeListener(t,n),e.apply(this,arguments)})},t.prototype.removeListener=function(t,e){if("function"!=typeof e)throw Error("removeListener only takes instances of Function");if(!this._events[t])return this;var r=this._events[t],n=r.indexOf(e);return 0>n?this:(r.splice(n,1),0===r.length&&delete this._events[t],this)},t.prototype.removeAllListeners=function(t){return t&&this._events[t]&&(this._events[t]=null),this},t.prototype.listeners=function(t){return this._events[t]},local.util.EventEmitter=t}(),this.local===void 0&&(this.local={}),this.local.http===void 0&&(this.local.http={}),this.local.http.ext===void 0&&(this.local.http.ext={}),function(){function t(){}function e(t,e){if(!t||"object"!=typeof t||!e)return t;var r=i(e,"serializer");return r?r(t):t}function r(t,e){if(!t||"string"!=typeof t||!e)return t;var r=i(e,"deserializer");return r?r(t):t}function n(t,e,r){_[t]={serializer:e,deserializer:r}}function o(t){var e=t.split(";"),r=e[0];if(e=r.split("/"),e[1]){var n=e[1].split("+");return n[1]?[r,e[0]+"/"+n[1],e[0]]:[r,e[0]]}return[r]}function i(t,e){for(var r=o(t),n=0;r.length>n;n++)if(r[n]in _)return _[r[n]][e];return null}function s(t,e){e.status>=200&&400>e.status?t.fulfill(e):e.status>=400&&600>e.status||0===e.status?t.reject(e):t.fulfill(e)}function a(t,e){var r=k[t.urld.host];if(!r){var n=new h(404,"server not found");return e.reject(n),n.end(),void 0}var o={path:t.urld.path,method:t.method,query:t.query||{},headers:t.headers||{},body:t.body,stream:t.stream};if(o.path=o.path?o.path.replace(/(.)\/$/,"$1"):"/",t.urld.query){var i=local.http.contentTypes.deserialize(t.urld.query,"application/x-www-form-urlencoded");for(var s in i)o.query[s]=i[s]}r.fn.call(r.context,o,new p(e,t.stream))}function l(t,e){if(t.query){var r=local.http.contentTypes.serialize(t.query,"application/x-www-form-urlencoded");r&&(t.urld.query?(t.urld.query+="&"+r,t.urld.relative+="&"+r):(t.urld.query=r,t.urld.relative+="?"+r))}"undefined"!=typeof window?c(t,e):u(t,e)}function c(t,e){var r=(t.urld.protocol?t.urld.protocol+"://":"")+t.urld.authority+t.urld.relative;local.http.serializeRequestHeaders(t.headers),null!==t.body&&t.body!==void 0&&(t.headers["content-type"]=t.headers["content-type"]||"application/json","string"!=typeof t.body&&(t.body=local.http.contentTypes.serialize(t.body,t.headers["content-type"])));var n=new XMLHttpRequest;n.open(t.method,r,!0);for(var o in t.headers)null!==t.headers[o]&&t.headers.hasOwnProperty(o)&&n.setRequestHeader(o,t.headers[o]);var i,a=0,l=0;n.onreadystatechange=function(){n.readyState>=XMLHttpRequest.HEADERS_RECEIVED&&!i&&(i=new h(n.status,n.statusText),i.on("close",function(){n.readyState!==XMLHttpRequest.DONE&&n.abort()}),n.getAllResponseHeaders().split("\n").forEach(function(t){if(t){var e=t.toLowerCase().replace("\r","").split(": ");i.headers[e[0]]=e[1]}}),i.headers.link&&(i.headers.link=local.http.parseLinkHeader(i.headers.link)),t.stream&&(s(e,i),a=setInterval(function(){var t=n.responseText.length;t>l&&(l=t,i.write(n.responseText,!0))},t.streamPoll||500))),n.readyState===XMLHttpRequest.DONE&&(i=i||new h(n.status,n.statusText),a&&clearInterval(a),i.write(n.responseText,!0),i.end(),t.stream||s(e,i))},n.send(t.body)}function u(t,e){var r=new h(0,"dispatch() has not yet been implemented for nodejs");e.reject(r),r.end()}function h(t,e){local.util.EventEmitter.call(this),this.status=t,this.reason=e,this.headers={},this.body=null,this.isConnOpen=!0}function p(t,e){local.util.EventEmitter.call(this),this.resPromise=t,this.isStreaming=e,this.clientResponse=new h}function f(t){var e=new g(local.http.dispatch({method:"get",url:"httpl://"+t.urld.authority+t.urld.relative,headers:{accept:"text/event-stream"},stream:!0}));return e}function d(t){return"undefined"!=typeof window?v(t):m(t)}function v(t){var e=(t.urld.protocol||"http")+"://"+t.urld.authority+t.urld.relative;return new b(e)}function m(){throw"subscribe() has not yet been implemented for nodejs"}function y(){local.util.EventEmitter.call(this),this.isConnOpen=!0}function g(t){y.call(this),this.response=null;var e=this;t.then(function(t){e.response=t,t.on("data",function(t){e.__emitEvent(t)}),t.on("end",function(){e.close()})},function(t){e.__emitError({event:"error",data:t}),e.close()})}function b(t){y.call(this),this.eventSource=new EventSource(t);var e=this;this.eventSource.onerror=function(t){t.target.readyState==EventSource.CLOSED&&e.close()}}function w(){this.streams=[]}function E(){return"undefined"!=typeof window?window.location.host:app?app.config.environmentHost:""}function x(t,e,r){this.rel=t,this.relparams=e,this.url=r,this.resolveState=x.UNRESOLVED,this.error=null}function L(t,e){if(this.context=t||null,this.parentNavigator=e||null,this.links=null,"string"==typeof this.context)this.context=new x(null,null,t);else if(!e)throw"parentNavigator is required for navigators with relative contexts"}local.http.parseLinkHeader=function(t){return"string"!=typeof t?t:t.replace(/,[\s]*</g,"|||<").split("|||").map(function(t){var e={};return t.trim().split(";").forEach(function(t){if(t=t.trim())if("<"===t.charAt(0))e.href=t.trim().slice(1,-1);else{var r=t.split("="),n=r[0].trim(),o=r[1].trim().slice(1,-1);e[n]=o}}),e})},local.http.lookupLink=function(t,e,r){var n=t?t.length:0;if(!n)return null;r&&(r=r.toLowerCase());for(var o=null,i=0;n>i;i++){var s=t[i];if(s&&s.rel&&-1!==s.rel.indexOf(e))if(r&&s.title){if(s.title.toLowerCase()===r){o=s;break}}else o=s}return o?o.href:null},local.http.joinUrl=function(){var t=Array.prototype.map.call(arguments,function(t){var e=0,r=t.length;return"/"===t.charAt(0)&&(e+=1),"/"===t.charAt(r-1)&&(r-=1),t.substring(e,r)});return t.join("/")},local.http.serializeRequestHeaders=function(t){if(t.authorization&&"object"==typeof t.authorization){if(!t.authorization.scheme)throw"`scheme` required for auth headers";var e;switch(t.authorization.scheme.toLowerCase()){case"basic":e="Basic "+btoa(t.authorization.name+":"+t.authorization.password);break;case"persona":e="Persona name="+t.authorization.name+" assertion="+t.authorization.assertion;break;default:throw"unknown auth sceme: "+t.authorization.scheme}t.authorization=e}},local.http.parseUri=function(t){"object"==typeof t&&(t.url?t=t.url:(t.host||t.path)&&(t=local.http.joinUrl(req.host,req.path)));for(var e=local.http.parseUri.options,r=e.parser[e.strictMode?"strict":"loose"].exec(t),n={},o=14;o--;)n[e.key[o]]=r[o]||"";return n[e.q.name]={},n[e.key[12]].replace(e.q.parser,function(t,r,o){r&&(n[e.q.name][r]=o)}),n},local.http.parseUri.options={strictMode:!1,key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],q:{name:"queryKey",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:{strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/}},local.http.pipe=function(t,e,r,n){return r=r||function(t){return t},n=n||function(t){return t},local.promise(e).succeed(function(e){return t.status||t.writeHead(e.status,e.reason,r(e.headers)),null!==e.body&&e.body!==void 0&&t.write(n(e.body)),e.on&&e.isConnOpen?(e.on("data",function(e){t.write(n(e))}),e.on("end",function(){t.end()})):t.end(),t}).fail(function(e){var r=e.headers["content-type"]||"text/plain",n=r&&e.body?e.body:"";throw t.writeHead(502,"bad gateway",{"content-type":r}),t.end(n),e})};var R={serialize:e,deserialize:r,register:n},_={};local.http.contentTypes=R,local.http.contentTypes.register("application/json",function(t){try{return JSON.stringify(t)}catch(e){return e.message}},function(t){try{return JSON.parse(t)}catch(e){return e.message}}),local.http.contentTypes.register("application/x-www-form-urlencoded",function(t){var e=encodeURIComponent,r=[];for(var n in t)if(null===t[n])r.push(n+"=");else if(Array.isArray(t[n]))for(var o=0;t[n].length>o;o++)r.push(n+"[]="+e(t[n][o]));else if("object"==typeof t[n])for(var i in t[n])r.push(n+"["+i+"]="+e(t[n][i]));else r.push(n+"="+e(t[n]));return r.join("&")},function(t){for(var e=t.split("&"),r={},n=0;e.length>n;n++){var o=e[n].split("="),i=decodeURIComponent(o[0]),s=decodeURIComponent(o[1]),a=/\[\]$/.test(i),l=i.match(/^(.+)\[([^\]]+)\]$/);if(l){i=l[1];var c=l[2];r[i]=r[i]||{},r[i][c]=s}else a?(i=i.substring(0,i.length-2),r[i]=r[i]||[],r[i].push(s)):r[i]=s}return r});var k={},A=null,C="undefined"!=typeof window?window.location.pathname.split("/"):[""];C[C.length-1]="",C=C.join("/"),local.http.dispatch=function(t){if(!t)throw"no req param provided to request";if(t.headers=t.headers||{},t.query=t.query||{},t.method=t.method?t.method.toUpperCase():"GET",A)return A(t);if(t.url||(t.url=local.http.joinUrl(t.host,t.path)),t.urld||(t.urld=local.http.parseUri(t.url)),!t.urld)throw"no URL or host/path provided in request";t.urld.protocol||(t.url=t.url.length>0&&"/"!=t.url.charAt(0)?window.location.protocol+"//"+window.location.host+C+t.url:window.location.protocol+"//"+window.location.host+t.url,t.urld=local.http.parseUri(t.url));var e=local.promise();if("httpl"==t.urld.protocol)setTimeout(function(){a(t,e)},0);else if("http"==t.urld.protocol||"https"==t.urld.protocol)setTimeout(function(){l(t,e)},0);else{var r=new h(0,'unsupported protocol "'+t.urld.protocol+'"');e.reject(r),r.end()}return e},local.http.setRequestDispatcher=function(t){A=t},local.http.ClientResponse=h,h.prototype=Object.create(local.util.EventEmitter.prototype),h.prototype.write=function(t,e){if(this.isConnOpen){if(e||"string"!=typeof t||"string"!=typeof this.body){var r=this.body&&"string"==typeof this.body?this.body.length:0;this.body=t,t="string"==typeof t?t.slice(r):t}else this.body+=t;this.emit("data",t)}},h.prototype.end=function(){this.isConnOpen&&(this.__deserialize(),this.isConnOpen=!1,this.emit("end"),this.close())},h.prototype.close=function(){this.isConnOpen&&(this.isConnOpen=!1,this.emit("close"),this.removeAllListeners("data"),this.removeAllListeners("end"),this.removeAllListeners("close"))},h.prototype.__deserialize=function(){"string"==typeof this.body&&(this.body=local.http.contentTypes.deserialize(this.body,this.headers["content-type"]))},local.http.ServerResponse=p,p.prototype=Object.create(local.util.EventEmitter.prototype),p.prototype.writeHead=function(t,e,r){this.clientResponse.status=t,this.clientResponse.reason=e;for(var n in r)r.hasOwnProperty(n)&&this.setHeader(n,r[n]);return this.isStreaming&&s(this.resPromise,this.clientResponse),this},p.prototype.setHeader=function(t,e){this.clientResponse.headers[t]=e},p.prototype.getHeader=function(t){return this.clientResponse.headers[t]},p.prototype.removeHeader=function(t){delete this.clientResponse.headers[t]},p.prototype.write=function(t){return this.clientResponse.write(t,!1),this},p.prototype.end=function(t){return t&&this.write(t),this.clientResponse.end(),this.emit("close"),this.removeAllListeners("close"),this.isStreaming||s(this.resPromise,this.clientResponse),this},p.prototype.writeContinue=t,p.prototype.addTrailers=t,p.prototype.sendDate=t,local.http.registerLocal=function(t,e,r){var n=local.http.parseUri(t);if(n.protocol&&"httpl"!==n.protocol)throw"registerLocal can only add servers to the httpl protocol";if(!n.host)throw"invalid domain provided to registerLocal";if(k[n.host])throw"server already registered at domain given to registerLocal";k[n.host]={fn:e,context:r}},local.http.unregisterLocal=function(t){var e=local.http.parseUri(t);if(!e.host)throw"invalid domain provided toun registerLocal";k[e.host]&&delete k[e.host]},local.http.getLocal=function(t){var e=local.http.parseUri(t);if(!e.host)throw"invalid domain provided toun registerLocal";return k[e.host]},local.http.getLocalRegistry=function(){return k};var C="undefined"!=typeof window?window.location.pathname.split("/"):[""];C[C.length-1]="",C=C.join("/");var S=null;local.http.subscribe=function(t){if(!t)throw"no options provided to subscribe";if("string"==typeof t&&(t={url:t}),S)return S(t);if(t.url||(t.url=local.http.joinUrl(t.host,t.path)),t.urld=local.http.parseUri(t.url),!t.urld)throw"no URL or host/path provided in request";return t.urld.protocol||(t.url=t.url.length>0&&"/"!=t.url.charAt(0)?window.location.protocol+"//"+window.location.host+C+t.url:window.location.protocol+"//"+window.location.host+t.url,t.urld=local.http.parseUri(t.url)),"httpl"==t.urld.protocol?f(t):d(t)},local.http.setEventSubscriber=function(t){S=t},local.http.EventStream=y,y.prototype=Object.create(local.util.EventEmitter.prototype),y.prototype.close=function(){this.isConnOpen=!1,this.emit("close"),this.removeAllListeners()},y.prototype.__emitError=function(t){this.emit("message",t),this.emit("error",t)},y.prototype.__emitEvent=function(t){this.emit("message",t),this.emit(t.event,t)},local.http.LocalEventStream=g,g.prototype=Object.create(y.prototype),g.prototype.close=function(){this.__emitError({event:"error",data:void 0}),y.prototype.close.call(this),this.response&&this.response.close(),this.response=null},local.http.BrowserRemoteEventStream=b,b.prototype=Object.create(y.prototype),b.prototype.addListener=function(t,e){if(Array.isArray(t))return t.forEach(function(t){this.addListener(t,e)},this),void 0;if(!this._events[t]){var r=this;this.eventSource.addEventListener(t,function(t){var e=t.data;try{e=JSON.parse(e)}catch(n){}r.__emitEvent({event:t.type,data:e})})}local.util.EventEmitter.prototype.addListener.call(this,t,e)},b.prototype.on=b.prototype.addListener,b.prototype.close=function(){this.eventSource.close(),this.eventSource.onerror=null,this.eventSource=null,y.prototype.close.call(this)},local.http.Broadcaster=w,w.prototype.addStream=function(t){this.streams.push(t);var e=this;t.clientResponse.on("close",function(){e.endStream(t)})},w.prototype.endStream=function(t){this.streams=this.streams.filter(function(e){return e!=t}),t.end()},w.prototype.endAllStreams=function(){this.streams.forEach(function(t){t.end()}),this.streams.length=0},w.prototype.emit=function(t,e){this.streams.forEach(function(r){this.emitTo(r,t,e)},this)},w.prototype.emitTo=function(t,e,r){t.write({event:e,data:r})},local.http.broadcaster=function(){return new w},function(){"use strict";function t(t){return"[object Array]"===Object.prototype.toString.apply(t)}function e(t,e,r){var n,o=r;for(n in t)t.hasOwnProperty(n)&&(o=e(o,t[n],n,t));return o}function r(t,e,r){var n,o=r;for(n=0;t.length>n;n+=1)o=e(o,t[n],n,t);return o}function n(n,o,i){return t(n)?r(n,o,i):e(n,o,i)}function o(e){var r,n;if(null===e||void 0===e)return!1;if(t(e)){for(r=0;e.length>r;r+=1)if(o(e[r]))return!0;return!1}if("string"==typeof e||"number"==typeof e||"boolean"==typeof e)return!0;for(n in e)if(e.hasOwnProperty(n)&&o(e[n]))return!0;return!1}function i(t){return t>="a"&&"z">=t||t>="A"&&"Z">=t}function s(t){return t>="0"&&"9">=t}function a(t){return s(t)||t>="a"&&"f">=t||t>="A"&&"F">=t}function l(t){return i(t)||s(t)||"_"===t||g.isPctEncoded(t)}function c(t){return i(t)||s(t)||"-"===t||"."===t||"_"===t||"~"===t}function u(t){return":"===t||"/"===t||"?"===t||"#"===t||"["===t||"]"===t||"@"===t||"!"===t||"$"===t||"&"===t||"("===t||")"===t||"*"===t||"+"===t||","===t||";"===t||"="===t||"'"===t}function h(t,e){var r,n="",o="";for(("number"==typeof t||"boolean"==typeof t)&&(t=""+t),r=0;t.length>r;r+=o.length)o=g.pctCharAt(t,r),n+=o.length>1?o:c(o)||e&&u(o)?o:g.encodeCharacter(o);return n}function p(t){return h(t,!0)}function f(t,e){this.templateText=t,this.expressions=e}function d(t){var e,r="",n="";for(e=0;t.length>e;e+=n.length)n=g.pctCharAt(t,e),r+=n.length>0?n:u(n)||c(n)?n:g.encodeCharacter(n);return r}function v(t){this.literal=d(t)}function m(t,e,r){this.templateText=t,this.operator=e,this.varspecs=r}function y(t){function e(){u={varname:n.substring(h,i),exploded:!1,maxLength:null},h=null}function r(){if(p===i)throw Error("after a ':' you have to specify the length. position = "+i);u.maxLength=parseInt(n.substring(p,i),10),p=null}var n,o,i,a,c=[],u=null,h=null,p=null;for(n=t.substr(1,t.length-2),i=0;n.length>i;i+=a.length){if(a=g.pctCharAt(n,i),0===i){if(o=b.valueOf(a),""!==o.symbol){h=1;continue}h=0}if(null!==h){if("."===a){if(h===i)throw Error("a varname MUST NOT start with a dot -- see position "+i);continue}if(l(a))continue;e()}if(null!==p){if(s(a))continue;r()}if(":"!==a)if("*"!==a){if(","!==a)throw Error("illegal character '"+a+"' at position "+i);c.push(u),u=null,h=i+1}else{if(null===u)throw Error("explode exploded at position "+i);if(u.exploded)throw Error("explode exploded twice at position "+i);if(u.maxLength)throw Error("an explode (*) MUST NOT follow to a prefix, see position "+i);u.exploded=!0}else{if(null!==u.maxLength)throw Error("only one :maxLength is allowed per varspec at position "+i);p=i+1}}return null!==h&&e(),null!==p&&r(),c.push(u),new m(t,o,c)}var g=function(){function t(t){return unescape(encodeURIComponent(t))}function e(e){var r,n,o="",i=t(e);for(n=0;i.length>n;n+=1)r=i.charCodeAt(n),o+="%"+r.toString(16).toUpperCase();return o}function r(t){if(3>t.length)return!1;for(var e=0;t.length>e;e+=3)if("%"!==t.charAt(e)||!a(t.charAt(e+1)||!a(t.charAt(e+2))))return!1;return!0}function n(t,e){var n=t.charAt(e);return"%"!==n?n:(n=t.substr(e,3),r(n)?n:"%")}return{encodeCharacter:e,decodeCharacter:decodeURIComponent,isPctEncoded:r,pctCharAt:n}}(),b=function(){function t(t){e[t]={symbol:t,separator:"?"===t?"&":""===t||"+"===t||"#"===t?",":t,named:";"===t||"&"===t||"?"===t,ifEmpty:"&"===t||"?"===t?"=":"",first:"+"===t?"":t,encode:"+"===t||"#"===t?p:h,toString:function(){return this.symbol}}}var e={};return t(""),t("+"),t("#"),t("."),t("/"),t(";"),t("?"),t("&"),{valueOf:function(t){if(e[t])return e[t];if("=,!@|".indexOf(t)>=0)throw Error('Illegal use of reserved operator "'+t+'"');return e[""]}}}();f.prototype.toString=function(){return this.templateText},f.prototype.expand=function(t){var e,r="";for(e=0;this.expressions.length>e;e+=1)r+=this.expressions[e].expand(t);return r},v.prototype.expand=function(){return this.literal},v.prototype.toString=v.prototype.expand,m.prototype.toString=function(){return this.templateText},m.prototype.expand=function(e){function r(t,e,r){return o(e)&&(t.length>0&&(t+=","),u||(t+=f.encode(r)+","),t+=f.encode(e)),t}function i(t,e,r){return o(e)&&(t.length>0&&(t+=f.separator),t+=u?d(l.varname):f.encode(r),t+="="+f.encode(e)),t}function s(t,e,r){return o(e)&&(t.length>0&&(t+=f.separator),u||(t+=f.encode(r)+"="),t+=f.encode(e)),t}var a,l,c,u,h="",p=!0,f=this.operator;for(a=0;this.varspecs.length>a;a+=1)if(l=this.varspecs[a],c=e[l.varname],o(c))if(p?(h+=this.operator.first,p=!1):h+=this.operator.separator,u=t(c),"string"==typeof c||"number"==typeof c||"boolean"==typeof c){if(c=""+c,this.operator.named){if(h+=d(l.varname),""===c){h+=this.operator.ifEmpty;continue}h+="="}l.maxLength&&c.length>l.maxLength&&(c=c.substr(0,l.maxLength)),h+=this.operator.encode(c)}else{if(l.maxLength)throw Error("Prefix modifiers are not applicable to variables that have composite values. You tried to expand "+this+" with "+JSON.stringify(c));if(l.exploded)h+=n(c,f.named?i:s,"");else{if(f.named){if(h+=d(l.varname),!o(c)){h+=this.operator.ifEmpty;continue}h+="="}h+=n(c,r,"")}}return h},f.parse=function(t){var e,r,n=[],o=null,i=0;for(e=0;t.length>e;e+=1)if(r=t.charAt(e),null===i){if(null===o)throw Error("reached unreachable code");if("{"===r)throw Error("brace was opened in position "+o+" and cannot be reopened in position "+e);if("}"===r){if(o+1===e)throw Error("empty braces on position "+o);n.push(y(t.substring(o,e+1))),o=null,i=e+1}}else{if("}"===r)throw Error("brace was closed in position "+e+" but never opened");"{"===r&&(e>i&&n.push(new v(t.substring(i,e))),i=null,o=e)}if(null!==o)throw Error("brace was opened on position "+o+", but never closed");return t.length>i&&n.push(new v(t.substr(i))),new f(t,n)},local.http.UriTemplate=f}();var q=["head","post","put","patch","delete"],U={Json:"application/json",Html:"text/html",Xml:"text/xml",Events:"text/event-stream",Eventstream:"text/event-stream",Plain:"text/plain",Text:"text/plain"},j=["alternate","author","collection","current","describedby","first","index","item","last","latest-version","monitor","monitor-group","next","next-archive","payment","predecessor-version","prev","prev-archive","related","replies","search","self","service","successor-version","up","version-history","via","working-copy","working-copy-of"];x.UNRESOLVED=0,x.RESOLVED=1,x.FAILED=2,x.prototype.isResolved=function(){return this.resolveState===x.RESOLVED},x.prototype.isBad=function(){return this.resolveState>1},x.prototype.isRelative=function(){return!this.url&&!!this.rel},x.prototype.isAbsolute=function(){return!!this.url},x.prototype.getUrl=function(){return this.url},x.prototype.getError=function(){return this.error},x.prototype.getHost=function(){if(!this.host){if(!this.url)return null;var t=local.http.parseUri(this.url);this.host=(t.protocol||"http")+"://"+(t.authority||E())}return this.host},x.prototype.resetResolvedState=function(){this.resolveState=x.UNRESOLVED,this.error=null},x.prototype.resolve=function(t){this.error=null,this.resolveState=x.RESOLVED,this.url=t;var e=local.http.parseUri(this.url);this.host=(e.protocol||"http")+"://"+e.authority},local.http.Navigator=L,L.prototype.dispatch=function(t){if(!t||!t.method)throw"request options not provided";var e=this,r=local.promise();return(t.noresolve?local.promise(this.context.getUrl()):this.resolve({retry:t.retry,nohead:!0})).succeed(function(e){return t.url=e,local.http.dispatch(t)}).succeed(function(t){return e.context.error=null,e.context.resolveState=x.RESOLVED,e.links=t.headers.link?t.headers.link:e.links||[],t}).fail(function(t){throw 404===t.status&&(e.context.error=t,e.context.resolveState=x.FAILED),t}).chain(r),r},L.prototype.subscribe=function(){return this.resolve().succeed(function(t){return local.http.subscribe(t)})},L.prototype.relation=function(t,e,r){var n=r||{};return n.title=(e||"").toLowerCase(),new L(new x(t,n),this)},L.prototype.resolve=function(t){var e=this;t=t||{};var r=t.nohead;delete t.nohead;var n=local.promise();return null!==this.links&&(this.context.isResolved()||this.context.isAbsolute()&&this.context.isBad()===!1)?n.fulfill(this.context.getUrl()):this.context.isBad()===!1||this.context.isBad()&&t.retry?(this.context.resetResolvedState(),this.parentNavigator?this.parentNavigator.__resolveChild(this,t).succeed(function(){return r?!0:e.head(null,null,null,{noresolve:!0})}).succeed(function(){return e.context.getUrl()}).chain(n):(r?local.promise(!0):this.head(null,null,null,{noresolve:!0})).succeed(function(){return e.context.getUrl()}).chain(n)):n.reject(this.context.getError()),n},L.prototype.__resolveChild=function(t,e){var r=this,n=local.promise();return this.resolve(e).then(function(){var e=r.__lookupLink(t.context);if(e)t.context.resolve(e),n.fulfill(e);else{var o=new local.http.ClientResponse(404,"link relation not found");n.reject(o),o.end()}},function(e){return t.context.error=e,t.context.resolveState=x.FAILED,n.reject(e),e}),n},L.prototype.__lookupLink=function(t){var e=local.http.lookupLink(this.links,t.rel,t.relparams.title);if(e){var r=local.http.UriTemplate.parse(e).expand(t.relparams),n=local.http.parseUri(r);return n.host||(r=this.context.getHost()+n.relative),r}return console.log("Failed to find a link to resolve context. Target link:",t.rel,t.relparams,"Navigator:",this),null},q.forEach(function(t){L.prototype[t]=function(e,r,n,o){var i=o||{};return i.headers=n||{},i.method=t,null!==e&&"null"!=typeof e&&/head/i.test(t)===!1&&(i.headers["content-type"]=r||("object"==typeof e?"application/json":"text/plain")),i.body=e,this.dispatch(i)}}),L.prototype.get=function(t,e,r){var n=r||{};return n.headers=e||{},n.method="get",n.headers.accept=t,this.dispatch(n)};for(var T in U)(function(t,e){L.prototype["get"+t]=function(t,r){return this.get(e,t,r)}})(T,U[T]);j.forEach(function(t){var e=t.replace(/-/g,"_");L.prototype[e]=function(e,r){return this.relation(t,e,r)}}),local.http.navigator=function(t,e,r){if(t instanceof L)return t;var n;return n=Array.isArray(t)?local.http.lookupLink(t,e,r):t,new L(n)}}(),this.local===void 0&&(this.local={}),this.local.client===void 0&&(this.local.client={}),function(){function t(t,e){for(;t;){if(e(t))return t;t=t.parentNode}return null}function e(){for(var t,r=Array.prototype.slice.call(arguments),n={};r.length;)if(t=r.shift())for(var o in t)void 0!==t[o]&&null!==t[o]&&(n[o]="object"!=typeof t[o]||Array.isArray(t[o])?t[o]:e(n[o],t[o]));return n}function r(t,e){var r=new CustomEvent("request",{bubbles:!0,cancelable:!0,detail:e});t.dispatchEvent(r)}function n(e){var r=t.thatisFormRelated(e);if(r){for(var n=0;r.form.length>n;n++)r.form[n].setAttribute("submitter",null);r.setAttribute("submitter","1")}}function o(r,n){var s={form:{},fieldset:{},elem:{}},a=null,l=null;if("FIELDSET"===r.tagName?a=r:"FORM"!==r.tagName&&(a=t.byTag(r,"FIELDSET")),"FORM"===r.tagName)l=r;else{var c=r.getAttribute("form")||(a?a.getAttribute("form"):null);c&&(l=n.querySelector("#"+c)),l||(l=t.byTag(r,"FORM"))}var u=i(r,l);l&&(s.form=o.fromForm(l,r)),a&&(s.fieldset=o.fromFormElement(a)),"A"===r.tagName?s.elem=o.fromAnchor(r):-1===["FORM","FIELDSET"].indexOf(r.tagName)&&(s.elem=o.fromFormElement(r));var h=e(s.form,s.fieldset,s.elem),p={};return p[/GET/i.test(h.method)?"query":"body"]=u,e(h,p)}function i(e,r,n){n||(n={});var o={};n.nofiles||(o.__fileReads=[]);for(var i=0;r.length>i;i++){var a=r[i];if(a.name&&t.byElement(a,e)){var l="1"==a.getAttribute("submitter");if("BUTTON"===a.tagName)l&&(o[a.name]=a.value);else if("INPUT"===a.tagName)switch(a.type.toLowerCase()){case"button":case"submit":l&&(o[a.name]=a.value);break;case"checkbox":a.checked&&(o[a.name]=(o[a.name]||[]).concat(a.value));break;case"radio":null!==a.getAttribute("checked")&&(o[a.name]=a.value);break;case"file":if(n.nofiles)break;if(a.multiple){for(var c,i=0;c=a.files[i];i++)s(o,a,a.files[i],i);o[a.name]=[],o[a.name].length=i}else s(o,a,a.files[0]);break;default:o[a.name]=a.value}else o[a.name]=a.value}}return o}function s(t,e,r,n){var o=new FileReader;o.onloadend=a(t,e,r,n),o.readAsDataURL(r)}function a(t,e,r,n){var o=local.promise();return t.__fileReads.push(o),function(t){var i={content:t.target.result||null,name:r.name,formattr:e.name,size:r.size,type:r.type,lastModifiedDate:r.lastModifiedDate};n!==void 0&&(i.formindex=n),o.fulfill(i)}}function l(t){var e=t.body?t.body.__fileReads:t.query?t.query.__fileReads:[];return local.promise.bundle(e).then(function(e){return t.body&&delete t.body.__fileReads,t.query&&delete t.query.__fileReads,e.forEach(function(e){e.formindex!==void 0?t.body[e.formattr][e.formindex]=e:t.body[e.formattr]=e}),t})}function c(t,e){if(!(t&&t instanceof Element))throw"Listen() requires a valid DOM element as a first parameter";t.__eventHandlers=[],e=e||{};var r;e.links!==!1&&(r={handleEvent:h,container:t},t.addEventListener("click",r),t.__eventHandlers.push(r)),e.forms!==!1&&(r={handleEvent:p,container:t},t.addEventListener("submit",r)),e.dragdrops!==!1&&(r={handleEvent:f,container:t},t.addEventListener("dragstart",r),t.__eventHandlers.push(r))}function u(t){t.__eventHandlers&&(t.__eventHandlers.forEach(function(e){t.removeEventListener(e)}),delete t.__eventHandlers);var e=t.querySelectorAll("[data-subscribe]");Array.prototype.forEach.call(e,function(t){if(t.__subscriptions){for(var e in t.__subscriptions)t.__subscriptions[e].close();delete t.__subscriptions}})}function h(t){if(0===t.button){n(t.target);var e=o.fromAnchor(t.target);if(!e||-1===["_top","_blank"].indexOf(e.target))return e?(t.preventDefault(),t.stopPropagation(),r(t.target,e),!1):void 0}}function p(t){var e=o(t.target,this.container);if(!e||-1===["_top","_blank"].indexOf(e.target))return e?(t.preventDefault(),t.stopPropagation(),l(e).then(function(){r(t.target,e)}),!1):void 0}function f(t){t.dataTransfer.effectAllowed="none";var e=null,r=t.target;n(r),"A"==r.tagName?e=o.fromAnchor(r):r.form&&(e=o(r.form,this.container)),e&&(t.dataTransfer.effectAllowed="link",t.dataTransfer.setData("application/request+json",JSON.stringify(e)),t.dataTransfer.setData("text/uri-list",e.url),t.dataTransfer.setData("text/plain",e.url))
}function d(t,e,r){r.body=r.body||"";var n=r.headers["content-type"];if(/application\/html\-deltas\+json/.test(n))"object"==typeof r.body&&Array.isArray(r.body)?Array.isArray(r.body[0])?r.body.forEach(function(r){v(r,t,e)}):v(r.body,t,e):console.log("Improperly-formed application/html-deltas+json object",r);else{var o="";/text\/html/.test(n)?o=""+r.body:("string"!=typeof r.body&&(o=JSON.stringify(r.body)),o=r.body.replace(/</g,"&lt;").replace(/>/g,"&gt;")),local.client.unlisten(t),t.innerHTML=o,local.env.postProcessRegion(t,e)}m(t,e),g(t,e)}function v(t,e,r){if("object"==typeof t&&Array.isArray(t)){var n,o,i,s=t.shift(),a=t.shift(),l=t;if(s&&a){var c=r.querySelectorAll(a),u=function(t){c[n].classList.add(t)},h=function(t){c[n].classList.remove(t)},p=function(t){c[n].classList.toggle(t)};for(n=0,o=c.length;o>n;n++)if(c[n]){var f=c[n];switch(s){case"replace":local.client.unlisten(f),f.innerHTML=l[0],local.env.postProcessRegion(f,r);break;case"remove":local.client.unlisten(f),f.parentNode.removeChild(f);break;case"append":f.innerHTML=f.innerHTML+l[0],local.env.postProcessRegion(f,r);break;case"prepend":f.innerHTML=l[0]+f.innerHTML,local.env.postProcessRegion(f,r);break;case"addClass":f.classList&&(l[0]||"").split(" ").forEach(u);break;case"removeClass":f.classList&&(l[0]||"").split(" ").forEach(h);break;case"toggleClass":f.classList&&(l[0]||"").split(" ").forEach(p);break;case"setAttribute":l[0]&&f.setAttribute(l[0],l[1]);break;case"navigate":i=local.env.getClientRegion(f.id),i?i.dispatchRequest(l[0]):console.log("html-delta navigate targeted non-client-region element",f,a)}}}}}function m(t,e){L.forEach(function(r){var n="on"+r,o=t.querySelectorAll("["+n+"]");Array.prototype.forEach.call(o,function(t){var o=t.getAttribute(n);t.addEventListener(r,y(o,e)),t.removeAttribute(n)})})}function y(t,n){return function(i){i.preventDefault(),i.stopPropagation();var s=o(i.currentTarget,n);s.method=t,l(s).then(function(){var n=/GET/i.test(t);n||s.body?n&&s.body&&(s.query=e(s.body,s.query),s.body={}):(s.body=s.query,s.query={}),r(i.target,s)})}}function g(t){var e=t.querySelectorAll("[data-subscribe]");Array.prototype.forEach.call(e,function(t){var e=t.dataset.subscribe.split(" "),r=e[0],n=e[1]||r;t.__subscriptions=t.__subscriptions||{};var o=t.__subscriptions[r];o||(o=t.__subscriptions[r]=local.http.subscribe({url:r}),o.on("update",b(n,t)),o.on("error",w()))})}function b(t,e){return function(){var n={method:"get",url:t,target:"_element",headers:{accept:"text/html"}};"FORM"==e.tagName&&(n.query=i(e,e,{nofiles:!0}),n.headers.accept=e.getAttribute("accept")||"text/html"),r(e,n)}}function w(){return function(t){var e=t.data;console.log("Client update stream error:",e)}}function E(t){if(this.id=t,this.context={url:"",urld:{},links:[],type:""},this.element=document.getElementById(t),!this.element)throw"Region target element not found";this.element.classList.add("client-region"),this.listenerFn=x.bind(this),this.element.addEventListener("request",this.listenerFn),local.client.listen(this.element)}function x(t){t.preventDefault(),t.stopPropagation();var e=t.detail;this.__prepareRequest(e);var r=this,n=function(n){r.__handleResponse(t,e,n)};local.http.dispatch(e,this).then(n,n)}t.byTag=function(e,r){return t(e,function(t){return t.tagName==r})},t.byClass=function(e,r){return t(e,function(t){return t.classList&&t.classList.contains(r)})},t.byElement=function(e,r){return t(e,function(t){return t===r})},t.thatisFormRelated=function(e){return t(e,function(t){return!!t.form})},o.fromAnchor=function(e){if(e=t.byTag(e,"A"),!e||!e.attributes.href||"#"==e.attributes.href.value.charAt(0))return null;var r={method:"get",url:e.attributes.href.value,target:e.getAttribute("target"),headers:{accept:e.getAttribute("type")}};return r},o.fromFormElement=function(t){var e={method:t.getAttribute("formmethod"),url:t.getAttribute("formaction"),target:t.getAttribute("formtarget"),headers:{"content-type":t.getAttribute("formenctype"),accept:t.getAttribute("formaccept")}};return e},o.fromForm=function(t,r){if(r&&!r.form)for(var n=0;t.length>n;n++){var o=t[n];if("1"==o.getAttribute("submitter")){r=o,o.setAttribute("submitter","0");break}}var i={submitter:{},form:{}};r&&(i.submitter={method:r.getAttribute("formmethod"),url:r.getAttribute("formaction"),target:r.getAttribute("formtarget"),headers:{"content-type":r.getAttribute("formenctype"),accept:r.getAttribute("formaccept")}}),i.form={method:t.getAttribute("method"),url:t.getAttribute("action"),target:t.getAttribute("target"),headers:{"content-type":t.getAttribute("enctype")||t.enctype,accept:t.getAttribute("accept")}},t.acceptCharset&&(i.form.headers.accept=t.acceptCharset);var s=e(i.form,i.submitter);return s},local.client.findParentNode=t,local.client.extractRequest=o,local.client.listen=c,local.client.unlisten=u;var L=["blur","change","click","dblclick","focus","keydown","keypress","keyup","load","mousedown","mousemove","mouseout","mouseover","mouseup","reset","select","submit","unload"];local.client.renderResponse=d,local.client.Region=E,E.prototype.dispatchRequest=function(t){"string"==typeof t&&(t={method:"get",url:t,headers:{accept:"text/html"}});var e=new CustomEvent("request",{bubbles:!0,cancelable:!0,detail:t});this.element.dispatchEvent(e)},E.prototype.terminate=function(){local.client.unlisten(this.element),this.element.removeEventListener("request",this.listenerFn)},E.prototype.__prepareRequest=function(t){t.headers=t.headers||{},t.headers.accept=t.headers.accept||"text/html",t.stream=!1;var e=local.http.parseUri(t);if(!e.protocol){var r;r=t.url.length>0&&"/"!=t.url.charAt(0)?this.context.urld.protocol+"://"+this.context.urld.host+this.context.urld.directory+t.url:this.context.urld.protocol+"://"+this.context.urld.host+t.url;var n=this.context.urld.host;do t.url=r,r=t.url.replace(/[^\/]+\/\.\.\//i,"");while(r!=t.url&&local.http.parseUri(r).host==n);delete t.host,delete t.path}},E.prototype.__handleResponse=function(t,e,r){r.headers=r.headers||{};var n=this.__chooseRequestTarget(t,e);if(n){var o=local.env.getClientRegion(n.id);switch(o&&o.__updateContext(e,r),r.status){case 204:break;case 205:"FORM"===n.tagName&&n.reset();break;case 303:var i={method:"get",url:r.headers.location,headers:{accept:"text/html"}};this.dispatchRequest(i);break;default:local.client.renderResponse(n,this.element,r)}}},E.prototype.__updateContext=function(t,e){var r=local.http.parseUri(t);this.context.urld=r,this.context.url=r.protocol+"://"+r.authority+r.directory,this.context.links=e.headers.link,this.context.type=e.headers["content-type"]},E.prototype.__chooseRequestTarget=function(t,e){return"_element"==e.target?t.target:document.getElementById(e.target)||this.element}}(),this.local===void 0&&(this.local={}),this.local.env===void 0&&(this.local.env={}),function(){(function(){function t(){return i++}function e(t,e){e=e||{},this.isLogging=e.log,this.messageListeners={},this.replyCbs={},this.messageBuffers={},t&&this.onNamedMessage("ready",t,this),this.worker=new Worker(e.bootstrapUrl||"worker.js"),r.call(this)}function r(){var t=this;this.worker.addEventListener("message",function(e){var r=e.data;if(this.isLogging&&console.log("receiving",r),"reply"===r.name){var n=t.replyCbs[r.reply_to];if(n)return n.func.call(n.context,r),delete t.replyCbs[r.reply_to],void 0}var o=t.messageListeners[r.name];if("endMessage"===r.name){var i=r.data;o=t.messageListeners[i],t.removeAllNamedMessageListeners(i)}o&&o.forEach(function(t){t.func.call(t.context,r)})})}function n(e,r,n){var o={id:t(),reply_to:n,name:e,data:r};return o}function o(t,e,r){t.name in this.messageBuffers?this.messageBuffers[t.name].push([t,e,r]):(e&&"function"==typeof e&&(this.replyCbs[t.id]={func:e,context:r}),this.isLogging&&console.log("sending",t),this.worker.postMessage(t))}var i=1;local.env.Worker=e,e.prototype.postNamedMessage=function(t,e,r,i){var s=n(t,e);return o.call(this,s,r,i),s.id},e.prototype.postReply=function(t,e,r,i){var s="object"==typeof t?t.id:t,a=n("reply",e,s);return o.call(this,a,r,i),a.id},e.prototype.endMessage=function(t){return this.postNamedMessage("endMessage",t)},e.prototype.addNamedMessageListener=function(t,e,r){t in this.messageListeners||(this.messageListeners[t]=[]),this.messageListeners[t].push({func:e,context:r})},e.prototype.onNamedMessage=e.prototype.addNamedMessageListener,e.prototype.removeNamedMessageListener=function(t,e){if(t in this.messageListeners){var r=function(t){return t.func!=e};this.messageListeners[t]=this.messageListeners[t].filter(r),0===this.messageListeners[t].length&&delete this.messageListeners[t]}},e.prototype.removeAllNamedMessageListeners=function(t){t in this.messageListeners&&delete this.messageListeners[t]},e.prototype.bufferMessages=function(t){t in this.messageBuffers||(this.messageBuffers[t]=[])},e.prototype.releaseMessages=function(t){if(t in this.messageBuffers){var e=this.messageBuffers[t];delete this.messageBuffers[t],e.forEach(function(t){o.apply(this,t)},this)}},e.prototype.nullify=function(t){this.postNamedMessage("nullify",t)},e.prototype.importScripts=function(t,e){this.postNamedMessage("importScripts",t,e)},e.prototype.terminate=function(){var t;for(t in this.messageListeners)delete this.messageListeners[t];for(t in this.replyCbs)delete this.replyCbs[t];this.worker.terminate(),this.worker=null}})(),function(){function t(){return n++}function e(){this.config={id:t(),domain:null}}function r(t,n){t=t||{},e.call(this),this.state=r.BOOT;for(var o in t)this.config[o]=t[o];this.config.src||(this.config.src=""),this.config.srcBaseUrl||(this.config.srcBaseUrl=/^data/.test(this.config.src)===!1?this.config.src.replace(/\/[^/]+$/,"/"):""),this.config.domain||(this.config.domain="<"+this.config.src.slice(0,40)+">"),this.config.environmentHost=window.location.host,this.loaderrorCb=n,this.readyMessage=null,this.canLoadUserscript=!1,this.activeEventStreams=[],this.worker=new local.env.Worker(null,{bootstrapUrl:local.env.config.workerBootstrapUrl}),this.worker.bufferMessages("httpRequest"),this.worker.onNamedMessage("ready",this.onWorkerReady,this),this.worker.onNamedMessage("terminate",this.terminate,this),this.worker.onNamedMessage("httpRequest",this.onWorkerHttpRequest,this),this.worker.onNamedMessage("httpSubscribe",this.onWorkerHttpSubscribe,this),this.worker.onNamedMessage("log",this.onWorkerLog,this)}var n=1;local.env.Server=e,e.prototype.handleHttpRequest=function(t,e){e.writeHead(0,"server not implemented"),e.end()},e.prototype.terminate=function(){},e.prototype.getSource=function(){return""+this.handleHttpRequest},local.env.WorkerServer=r,r.prototype=Object.create(e.prototype),r.BOOT=0,r.READY=1,r.ACTIVE=2,r.DEAD=3,r.prototype.onWorkerReady=function(t){this.worker.nullify("XMLHttpRequest"),this.worker.nullify("Worker"),this.worker.nullify("importScripts"),this.state=r.READY,this.readyMessage=t,this.canLoadUserscript&&this.loadUserScript()},r.prototype.loadUserScript=function(){if(this.canLoadUserscript=!0,this.state==r.READY){this.worker.postReply(this.readyMessage,this.config);var t=this.config.src;0===t.indexOf("data:application/javascript,")&&(t="data:application/javacsript;base64,"+btoa(t.slice(28)));var e=this;this.worker.importScripts(t,function(t){return t.data.error?(e.loaderrorCb&&e.loaderrorCb(t.data),e.terminate(),void 0):(e.state!=r.DEAD&&(e.state=r.ACTIVE,e.worker.releaseMessages("httpRequest")),void 0)})}},r.prototype.terminate=function(){this.state=r.DEAD,this.activeEventStreams.forEach(function(t){t&&t.close()}),this.worker.terminate()},r.prototype.getSource=function(t){if(/^data/.test(this.config.src))return 0===this.config.src.indexOf("data:application/javascript;base64,")?local.promise(atob(this.config.src.split(",")[1]||"")):local.promise(this.config.src.split(",")[1]||"");var e={method:"get",url:this.config.src,headers:{accept:"application/javascript"}};return local.http.dispatch(e,t).then(function(t){return t.body},function(t){return console.log("failed to retrieve worker source:",t),""})},r.prototype.onWorkerLog=function(t){console.log("["+this.config.domain+"]",t.data)},r.prototype.onWorkerHttpRequest=function(t){var e=this;t.data;var r=function(r){var n=e.worker.postReply(t,r);r.isConnOpen?(r.on("data",function(t){e.worker.postNamedMessage(n,t)}),r.on("end",function(){e.worker.endMessage(n)})):e.worker.endMessage(n)};local.http.dispatch(t.data,this).then(r,r)},r.prototype.onWorkerHttpSubscribe=function(t){var e=this,n=t.data,o=local.http.subscribe(n),i=this.activeEventStreams.push(o);o.on("error",function(){e.activeEventStreams[i]=null}),this.worker.onNamedMessage(t.id,function(t){if("endMessage"==t)o.close();else{var n=t.data,i=e.worker.postReply(t);o.on(n,function(t){e.state!=r.DEAD&&e.worker.postNamedMessage(i,t)})}})},r.prototype.handleHttpRequest=function(t,e){var r=this.worker,n=r.postNamedMessage("httpRequest",t,function(t){if(!t.data)throw"Invalid httpRequest reply to document from worker";e.writeHead(t.data.status,t.data.reason,t.data.headers),t.data.body!==void 0&&null!==t.data.body&&e.write(t.data.body),r.onNamedMessage(t.id,function(t){"endMessage"===t.name?e.end():e.write(t.data)})},this);t.stream&&e.clientResponse.on("close",function(){r.endMessage(n)})}}(),local.env.config={workerBootstrapUrl:"lib/worker.min.js"},local.env.servers={},local.env.clientRegions={},local.env.numServers=0,local.env.numClientRegions=0,local.env.addServer=function(t,e){return e.config.domain=t,local.env.servers[t]=e,local.env.numServers++,e.loadUserScript&&e.loadUserScript(),local.http.registerLocal(t,e.handleHttpRequest,e),e},local.env.killServer=function(t){var e=local.env.servers[t];e&&(local.http.unregisterLocal(t),e.terminate(),delete local.env.servers[t],local.env.numServers--)},local.env.getServer=function(t){return local.env.servers[t]},local.env.listFilteredServers=function(t){var e={};for(var r in local.env.servers)t(local.env.servers[r],r)&&(e[r]=local.env.servers[r]);return e},local.env.addClientRegion=function(t){var e;return"object"==typeof t?e=t.id:(e=t,t=new local.client.Region(e)),local.env.clientRegions[t.id]=t,local.env.numClientRegions++,t},local.env.removeClientRegion=function(t){local.env.clientRegions[t]&&(local.env.clientRegions[t].terminate(),delete local.env.clientRegions[t],local.env.numClientRegions--)},local.env.getClientRegion=function(t){return local.env.clientRegions[t]};var t,e=local.http.dispatch;local.http.dispatch=function(r,n){if(r.headers=r.headers||{},r.query=r.query||{},r.method=r.method?r.method.toUpperCase():"GET",r.url||(r.url=local.http.joinUrl(r.host,r.path)),r.urld||(r.urld=local.http.parseUri(r.url)),r.urld.query){var o=local.http.contentTypes.deserialize(r.urld.query,"application/x-www-form-urlencoded");for(var i in o)r.query[i]=o[i];delete r.urld.query,r.urld.relative=r.urld.path}var s=t.call(this,r,n,e);if(s instanceof local.Promise)return s;if(s){if(!(s instanceof local.http.ClientResponse))if("object"==typeof s){var a=new local.http.ClientResponse(s.status,s.reason);a.headers=s.headers,a.end(s.body),s=a}else s=new local.http.ClientResponse(0,""+s),s.end()}else s=new local.http.ClientResponse(0,"Environment did not correctly dispatch the request"),s.end();var l=local.promise();return s.status>=400||0===s.status?l.reject(s):l.fulfill(s),l},t=function(t,e,r){return r(t)},local.env.setDispatchWrapper=function(e){t=e};var r=function(){};local.env.postProcessRegion=function(t,e){return r(t,e)},local.env.setRegionPostProcessor=function(t){r=t}}();