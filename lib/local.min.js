(function(){function e(e){return e&&typeof e.then=="function"}function t(e){this.succeedCBs=[],this.failCBs=[],this.__hasValue=!1,this.__hasFailed=!1,this.value=void 0,e&&this.fulfill(e)}function r(t,r,n){if(null===n)t.isRejected()?r.reject(t.value):r.fulfill(t.value);else{var o;try{o=n(t.value)}catch(i){i instanceof Error&&(console.error?console.error(i,i.stack):console.log("Promise exception thrown",i,i.stack)),r.reject(i)}e(o)?s(o).chain(r):r.fulfill(o)}}function n(e,t){Array.isArray(e)||(e=[e]);var r=s(),n=e.length,o=0;if(0===n)return r.fulfill([]),r;var i=[];i.length=n;for(var a=[],l=function(e,s,l){i[s]=e,l&&a.push(s),++o==n&&(t?t(i,a)?r.fulfill(i):r.reject(i):r.fulfill(i))},c=0;n>c;c++)s(e[c]).succeed(l,c,!1).fail(l,c,!0);return r}function o(e){return n(e,function(e,t){return t.length===0})}function i(e){return n(e,function(e,t){return t.length<e.length})}function s(r){if(arguments.length>1)return n(Array.prototype.slice.call(arguments));if(r instanceof t)return r;if(e(r)){var o=s();return r.then(function(e){o.fulfill(e)},function(e){o.reject(e)}),o}return new t(r)}var a=this;"undefined"!=typeof window?(typeof window.local=="undefined"&&(window.local={}),a=window.local):"undefined"!=typeof self?(typeof self.local=="undefined"&&(self.local={}),a=self.local):"undefined"!=typeof module&&(a=module.exports),t.prototype.isUnfulfilled=function(){return!this.__hasValue},t.prototype.isRejected=function(){return this.__hasFailed},t.prototype.isFulfilled=function(){return this.__hasValue&&!this.__hasFailed},t.prototype.then=function(e,t){e=e&&"function"==typeof e?e:null,t=t&&"function"==typeof t?t:null;var n=s();if(this.isUnfulfilled())this.succeedCBs.push({p:n,fn:e}),this.failCBs.push({p:n,fn:t});else{var o=this;setTimeout(function(){o.isFulfilled()?r(o,n,e):r(o,n,t)},0)}return n},t.prototype.succeed=function(e){if(this.isRejected())return this;var t=Array.prototype.slice.call(arguments,1);return this.then(function(r){return e.apply(null,[r].concat(t))})},t.prototype.fail=function(e){if(this.isFulfilled())return this;var t=Array.prototype.slice.call(arguments,1);return this.then(null,function(r){return e.apply(null,[r].concat(t))})},t.prototype.always=function(e){return this.then(e,e)},t.prototype.fulfill=function(e){if(this.isUnfulfilled()){this.value=e,this.__hasValue=!0;for(var t=0;t<this.succeedCBs.length;t++){var n=this.succeedCBs[t];r(this,n.p,n.fn)}this.succeedCBs.length=0,this.failCBs.length=0}return this},t.prototype.reject=function(e){if(this.isUnfulfilled()){this.value=e,this.__hasValue=!0,this.__hasFailed=!0;for(var t=0;t<this.failCBs.length;t++){var n=this.failCBs[t];r(this,n.p,n.fn)}this.succeedCBs.length=0,this.failCBs.length=0}return this},t.prototype.cancel=function(){var e;for(e=0;e<this.succeedCBs.length;e++)this.succeedCBs[e].p.cancel();for(e=0;e<this.failCBs.length;e++)this.failCBs[e].p.cancel();return this.succeedCBs.length=0,this.failCBs.length=0,this},t.prototype.chain=function(e){return this.then(function(t){return s(e).fulfill(t),t},function(t){return s(e).reject(t),t}),e},t.prototype.cb=function(e,t){e?this.reject(e):this.fulfill("undefined"==typeof t?null:t)},a.Promise=t,a.promise=s,a.promise.bundle=n,a.promise.all=o,a.promise.any=i})(),"undefined"!=typeof define&&define([],function(){return Promise}),typeof this.local=="undefined"&&(this.local={}),typeof this.local.util=="undefined"&&(this.local.util={}),function(){function e(){Object.defineProperty(this,"_events",{value:{},configurable:!0,enumerable:!1})}e.prototype.emit=function(e){var t=this._events[e];if(!t)return!1;for(var r=Array.prototype.slice.call(arguments,1),n=0,o=t.length;o>n;n++)t[n].apply(this,r);return!0},e.prototype.addListener=function(e,t){if(Array.isArray(e))return e.forEach(function(e){this.addListener(e,t)},this),void 0;if("function"!=typeof t)throw new Error("addListener only takes instances of Function");return this.emit("newListener",e,t),this._events[e]?this._events[e].push(t):this._events[e]=[t],this},e.prototype.on=e.prototype.addListener,e.prototype.once=function(e,t){var r=this;r.on(e,function n(){r.removeListener(e,n),t.apply(this,arguments)})},e.prototype.removeListener=function(e,t){if("function"!=typeof t)throw new Error("removeListener only takes instances of Function");if(!this._events[e])return this;var r=this._events[e],n=r.indexOf(t);return 0>n?this:(r.splice(n,1),r.length===0&&delete this._events[e],this)},e.prototype.removeAllListeners=function(e){return e&&this._events[e]&&(this._events[e]=null),this},e.prototype.listeners=function(e){return this._events[e]},local.util.EventEmitter=e}(),typeof this.local=="undefined"&&(this.local={}),typeof this.local.http=="undefined"&&(this.local.http={}),typeof this.local.http.ext=="undefined"&&(this.local.http.ext={}),function(){function e(){}function t(e,t){if(!e||"object"!=typeof e||!t)return e;var r=i(t,"serializer");return r?r(e):e}function r(e,t){if(!e||"string"!=typeof e||!t)return e;var r=i(t,"deserializer");return r?r(e):e}function n(e,t,r){_[e]={serializer:t,deserializer:r}}function o(e){var t=e.split(";"),r=t[0];if(t=r.split("/"),t[1]){var n=t[1].split("+");return n[1]?[r,t[0]+"/"+n[1],t[0]]:[r,t[0]]}return[r]}function i(e,t){for(var r=o(e),n=0;n<r.length;n++)if(r[n]in _)return _[r[n]][t];return null}function s(e,t){t.status>=200&&t.status<400?e.fulfill(t):t.status>=400&&t.status<600||t.status===0?e.reject(t):e.fulfill(t)}function a(e,t){var r=k[e.urld.host];if(!r){var n=new p(404,"server not found");return t.reject(n),n.end(),void 0}var o={path:e.urld.path,method:e.method,query:e.query||{},headers:e.headers||{},body:e.body,stream:e.stream};if(o.path=o.path?o.path.replace(/(.)\/$/,"$1"):"/",e.urld.query){var i=local.http.contentTypes.deserialize(e.urld.query,"application/x-www-form-urlencoded");for(var s in i)o.query[s]=i[s]}r.fn.call(r.context,o,new h(t,e.stream))}function l(e,t){if(e.query){var r=local.http.contentTypes.serialize(e.query,"application/x-www-form-urlencoded");r&&(e.urld.query?(e.urld.query+="&"+r,e.urld.relative+="&"+r):(e.urld.query=r,e.urld.relative+="?"+r))}"undefined"!=typeof window?c(e,t):u(e,t)}function c(e,t){var r=(e.urld.protocol?e.urld.protocol+"://":"")+e.urld.authority+e.urld.relative;local.http.serializeRequestHeaders(e.headers),e.body!==null&&typeof e.body!="undefined"&&(e.headers["content-type"]=e.headers["content-type"]||"application/json",typeof e.body!="string"&&(e.body=local.http.contentTypes.serialize(e.body,e.headers["content-type"])));var n=new XMLHttpRequest;n.open(e.method,r,!0);for(var o in e.headers)e.headers[o]!==null&&e.headers.hasOwnProperty(o)&&n.setRequestHeader(o,e.headers[o]);var i,a=0,l=0;n.onreadystatechange=function(){if(n.readyState>=XMLHttpRequest.HEADERS_RECEIVED&&!i){if(i=new p(n.status,n.statusText),i.on("close",function(){n.readyState!==XMLHttpRequest.DONE&&n.abort()}),n.getAllResponseHeaders())n.getAllResponseHeaders().split("\n").forEach(function(e){if(e){var t=e.toLowerCase().replace("\r","").split(": ");i.headers[t[0]]=t[1]}});else{var r=function(e){var t=n.getResponseHeader(e);t&&(i.headers[e.toLowerCase()]=t.toLowerCase())};r("Accept-Ranges"),r("Age"),r("Allow"),r("Cache-Control"),r("Connection"),r("Content-Encoding"),r("Content-Language"),r("Content-Length"),r("Content-Location"),r("Content-MD5"),r("Content-Disposition"),r("Content-Range"),r("Content-Type"),r("Date"),r("ETag"),r("Expires"),r("Last-Modified"),r("Link"),r("Location"),r("Pragma"),r("Refresh"),r("Retry-After"),r("Server"),r("Set-Cookie"),r("Trailer"),r("Transfer-Encoding"),r("Vary"),r("Via"),r("Warning"),r("WWW-Authenticate")}i.headers.link&&(i.headers.link=local.http.parseLinkHeader(i.headers.link)),e.stream&&(s(t,i),a=setInterval(function(){var e=n.responseText.length;e>l&&(l=e,i.write(n.responseText,!0))},e.streamPoll||500))}n.readyState===XMLHttpRequest.DONE&&(i=i||new p(n.status,n.statusText),a&&clearInterval(a),i.write(n.responseText,!0),i.end(),e.stream||s(t,i))},n.send(e.body)}function u(e,t){var r=new p(0,"dispatch() has not yet been implemented for nodejs");t.reject(r),r.end()}function p(e,t){local.util.EventEmitter.call(this),this.status=e,this.reason=t,this.headers={},this.body=null,this.isConnOpen=!0}function h(e,t){local.util.EventEmitter.call(this),this.resPromise=e,this.isStreaming=t,this.clientResponse=new p}function f(e){var t=new g(local.http.dispatch({method:"get",url:"httpl://"+e.urld.authority+e.urld.relative,headers:{accept:"text/event-stream"},stream:!0}));return t}function d(e){return"undefined"!=typeof window?v(e):m(e)}function v(e){var t=(e.urld.protocol||"http")+"://"+e.urld.authority+e.urld.relative;return new b(t)}function m(){throw"subscribe() has not yet been implemented for nodejs"}function y(){local.util.EventEmitter.call(this),this.isConnOpen=!0}function g(e){y.call(this),this.response=null;var t=this;e.then(function(e){t.response=e,e.on("data",function(e){t.__emitEvent(e)}),e.on("end",function(){t.close()})},function(e){t.__emitError({event:"error",data:e}),t.close()})}function b(e){y.call(this),this.eventSource=new EventSource(e);var t=this;this.eventSource.onerror=function(e){e.target.readyState==EventSource.CLOSED&&t.close()}}function w(){this.streams=[]}function E(){return"undefined"!=typeof window?window.location.host:app?app.config.environmentHost:""}function L(e,t,r){this.rel=e,this.relparams=t,this.url=r,this.resolveState=L.UNRESOLVED,this.error=null}function R(e,t){if(this.context=e||null,this.parentNavigator=t||null,this.links=null,typeof this.context=="string")this.context=new L(null,null,e);else if(!t)throw"parentNavigator is required for navigators with relative contexts"}local.http.parseLinkHeader=function(e){return"string"!=typeof e?e:e.replace(/,[\s]*</g,"|||<").split("|||").map(function(e){var t={};return e.trim().split(";").forEach(function(e){if(e=e.trim())if(e.charAt(0)==="<")t.href=e.trim().slice(1,-1);else{var r=e.split("="),n=r[0].trim(),o=r[1].trim().slice(1,-1);t[n]=o}}),t})},local.http.lookupLink=function(e,t,r){var n=e?e.length:0;if(!n)return null;r&&(r=r.toLowerCase());for(var o=null,i=0;n>i;i++){var s=e[i];if(s&&s.rel&&s.rel.indexOf(t)!==-1)if(r&&s.title){if(s.title.toLowerCase()===r){o=s;break}}else o=s}return o?o.href:null},local.http.joinUrl=function(){var e=Array.prototype.map.call(arguments,function(e){var t=0,r=e.length;return e.charAt(0)==="/"&&(t+=1),e.charAt(r-1)==="/"&&(r-=1),e.substring(t,r)});return e.join("/")},local.http.serializeRequestHeaders=function(e){if(e.authorization&&typeof e.authorization=="object"){if(!e.authorization.scheme)throw"`scheme` required for auth headers";var t;switch(e.authorization.scheme.toLowerCase()){case"basic":t="Basic "+btoa(e.authorization.name+":"+e.authorization.password);break;case"persona":t="Persona name="+e.authorization.name+" assertion="+e.authorization.assertion;break;default:throw"unknown auth sceme: "+e.authorization.scheme}e.authorization=t}},local.http.parseUri=function(e){"object"==typeof e&&(e.url?e=e.url:(e.host||e.path)&&(e=local.http.joinUrl(req.host,req.path)));for(var t=local.http.parseUri.options,r=t.parser[t.strictMode?"strict":"loose"].exec(e),n={},o=14;o--;)n[t.key[o]]=r[o]||"";return n[t.q.name]={},n[t.key[12]].replace(t.q.parser,function(e,r,o){r&&(n[t.q.name][r]=o)}),n},local.http.parseUri.options={strictMode:!1,key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],q:{name:"queryKey",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:{strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/}},local.http.pipe=function(e,t,r,n){return r=r||function(e){return e},n=n||function(e){return e},local.promise(t).succeed(function(t){return e.status||e.writeHead(t.status,t.reason,r(t.headers)),t.body!==null&&typeof t.body!="undefined"&&e.write(n(t.body)),t.on&&t.isConnOpen?(t.on("data",function(t){e.write(n(t))}),t.on("end",function(){e.end()})):e.end(),e}).fail(function(t){var r=t.headers["content-type"]||"text/plain",n=r&&t.body?t.body:"";throw e.writeHead(502,"bad gateway",{"content-type":r}),e.end(n),t})};var x={serialize:t,deserialize:r,register:n},_={};local.http.contentTypes=x,local.http.contentTypes.register("application/json",function(e){try{return JSON.stringify(e)}catch(t){return t.message}},function(e){try{return JSON.parse(e)}catch(t){return t.message}}),local.http.contentTypes.register("application/x-www-form-urlencoded",function(e){var t=encodeURIComponent,r=[];for(var n in e)if(e[n]===null)r.push(n+"=");else if(Array.isArray(e[n]))for(var o=0;o<e[n].length;o++)r.push(n+"[]="+t(e[n][o]));else if(typeof e[n]=="object")for(var i in e[n])r.push(n+"["+i+"]="+t(e[n][i]));else r.push(n+"="+t(e[n]));return r.join("&")},function(e){for(var t=e.split("&"),r={},n=0;n<t.length;n++){var o=t[n].split("="),i=decodeURIComponent(o[0]),s=decodeURIComponent(o[1]),a=/\[\]$/.test(i),l=i.match(/^(.+)\[([^\]]+)\]$/);if(l){i=l[1];var c=l[2];r[i]=r[i]||{},r[i][c]=s}else a?(i=i.substring(0,i.length-2),r[i]=r[i]||[],r[i].push(s)):r[i]=s}return r});var k={},A=null,C="undefined"!=typeof window?window.location.pathname.split("/"):[""];C[C.length-1]="",C=C.join("/"),local.http.dispatch=function(e){if(!e)throw"no req param provided to request";if(e.headers=e.headers||{},e.query=e.query||{},e.method=e.method?e.method.toUpperCase():"GET",A)return A(e);if(e.url||(e.url=local.http.joinUrl(e.host,e.path)),e.urld||(e.urld=local.http.parseUri(e.url)),!e.urld)throw"no URL or host/path provided in request";e.urld.protocol||(e.url=e.url.length>0&&e.url.charAt(0)!="/"?window.location.protocol+"//"+window.location.host+C+e.url:window.location.protocol+"//"+window.location.host+e.url,e.urld=local.http.parseUri(e.url));var t=local.promise();if(e.urld.protocol=="httpl")setTimeout(function(){a(e,t)},0);else if(e.urld.protocol=="http"||e.urld.protocol=="https")setTimeout(function(){l(e,t)},0);else{var r=new p(0,'unsupported protocol "'+e.urld.protocol+'"');t.reject(r),r.end()}return t},local.http.setRequestDispatcher=function(e){A=e},local.http.ClientResponse=p,p.prototype=Object.create(local.util.EventEmitter.prototype),p.prototype.write=function(e,t){if(this.isConnOpen){if(t||"string"!=typeof e||typeof this.body!="string"){var r=this.body&&typeof this.body=="string"?this.body.length:0;this.body=e,e="string"==typeof e?e.slice(r):e}else this.body+=e;this.emit("data",e)}},p.prototype.end=function(){this.isConnOpen&&(this.__deserialize(),this.isConnOpen=!1,this.emit("end"),this.close())},p.prototype.close=function(){this.isConnOpen&&(this.isConnOpen=!1,this.emit("close"),this.removeAllListeners("data"),this.removeAllListeners("end"),this.removeAllListeners("close"))},p.prototype.__deserialize=function(){typeof this.body=="string"&&(this.body=local.http.contentTypes.deserialize(this.body,this.headers["content-type"]))},local.http.ServerResponse=h,h.prototype=Object.create(local.util.EventEmitter.prototype),h.prototype.writeHead=function(e,t,r){if(this.clientResponse.status=e,this.clientResponse.reason=t,r)for(var n in r)r.hasOwnProperty(n)&&this.setHeader(n,r[n]);return this.isStreaming&&s(this.resPromise,this.clientResponse),this},h.prototype.setHeader=function(e,t){this.clientResponse.headers[e]=t},h.prototype.getHeader=function(e){return this.clientResponse.headers[e]},h.prototype.removeHeader=function(e){delete this.clientResponse.headers[e]},h.prototype.write=function(e){return this.clientResponse.write(e,!1),this},h.prototype.end=function(e){return e&&this.write(e),this.clientResponse.end(),this.emit("close"),this.removeAllListeners("close"),this.isStreaming||s(this.resPromise,this.clientResponse),this},h.prototype.writeContinue=e,h.prototype.addTrailers=e,h.prototype.sendDate=e,local.http.registerLocal=function(e,t,r){var n=local.http.parseUri(e);if(n.protocol&&n.protocol!=="httpl")throw"registerLocal can only add servers to the httpl protocol";if(!n.host)throw"invalid domain provided to registerLocal";if(k[n.host])throw"server already registered at domain given to registerLocal";k[n.host]={fn:t,context:r}},local.http.unregisterLocal=function(e){var t=local.http.parseUri(e);if(!t.host)throw"invalid domain provided toun registerLocal";k[t.host]&&delete k[t.host]},local.http.getLocal=function(e){var t=local.http.parseUri(e);if(!t.host)throw"invalid domain provided toun registerLocal";return k[t.host]},local.http.getLocalRegistry=function(){return k};var C="undefined"!=typeof window?window.location.pathname.split("/"):[""];C[C.length-1]="",C=C.join("/");var S=null;local.http.subscribe=function(e){if(!e)throw"no options provided to subscribe";if("string"==typeof e&&(e={url:e}),S)return S(e);if(e.url||(e.url=local.http.joinUrl(e.host,e.path)),e.urld=local.http.parseUri(e.url),!e.urld)throw"no URL or host/path provided in request";return e.urld.protocol||(e.url=e.url.length>0&&e.url.charAt(0)!="/"?window.location.protocol+"//"+window.location.host+C+e.url:window.location.protocol+"//"+window.location.host+e.url,e.urld=local.http.parseUri(e.url)),e.urld.protocol=="httpl"?f(e):d(e)},local.http.setEventSubscriber=function(e){S=e},local.http.EventStream=y,y.prototype=Object.create(local.util.EventEmitter.prototype),y.prototype.close=function(){this.isConnOpen=!1,this.emit("close"),this.removeAllListeners()},y.prototype.__emitError=function(e){this.emit("message",e),this.emit("error",e)},y.prototype.__emitEvent=function(e){this.emit("message",e),this.emit(e.event,e)},local.http.LocalEventStream=g,g.prototype=Object.create(y.prototype),g.prototype.close=function(){this.__emitError({event:"error",data:void 0}),y.prototype.close.call(this),this.response&&this.response.close(),this.response=null},local.http.BrowserRemoteEventStream=b,b.prototype=Object.create(y.prototype),b.prototype.addListener=function(e,t){if(Array.isArray(e))return e.forEach(function(e){this.addListener(e,t)},this),void 0;if(!this._events[e]){var r=this;this.eventSource.addEventListener(e,function(e){var t=e.data;try{t=JSON.parse(t)}catch(n){}r.__emitEvent({event:e.type,data:t})})}local.util.EventEmitter.prototype.addListener.call(this,e,t)},b.prototype.on=b.prototype.addListener,b.prototype.close=function(){this.eventSource.close(),this.eventSource.onerror=null,this.eventSource=null,y.prototype.close.call(this)},local.http.Broadcaster=w,w.prototype.addStream=function(e){this.streams.push(e);var t=this;e.clientResponse.on("close",function(){t.endStream(e)})},w.prototype.endStream=function(e){this.streams=this.streams.filter(function(t){return t!=e}),e.end()},w.prototype.endAllStreams=function(){this.streams.forEach(function(e){e.end()}),this.streams.length=0},w.prototype.emit=function(e,t){this.streams.forEach(function(r){this.emitTo(r,e,t)},this)},w.prototype.emitTo=function(e,t,r){e.write({event:t,data:r})},local.http.broadcaster=function(){return new w},function(){"use strict";function e(e){return Object.prototype.toString.apply(e)==="[object Array]"}function t(e,t,r){var n,o=r;for(n in e)e.hasOwnProperty(n)&&(o=t(o,e[n],n,e));return o}function r(e,t,r){var n,o=r;for(n=0;n<e.length;n+=1)o=t(o,e[n],n,e);return o}function n(n,o,i){return e(n)?r(n,o,i):t(n,o,i)}function o(t){var r,n;if(null===t||void 0===t)return!1;if(e(t)){for(r=0;r<t.length;r+=1)if(o(t[r]))return!0;return!1}if("string"==typeof t||"number"==typeof t||"boolean"==typeof t)return!0;for(n in t)if(t.hasOwnProperty(n)&&o(t[n]))return!0;return!1}function i(e){return e>="a"&&"z">=e||e>="A"&&"Z">=e}function s(e){return e>="0"&&"9">=e}function a(e){return s(e)||e>="a"&&"f">=e||e>="A"&&"F">=e}function l(e){return i(e)||s(e)||"_"===e||g.isPctEncoded(e)}function c(e){return i(e)||s(e)||"-"===e||"."===e||"_"===e||"~"===e}function u(e){return":"===e||"/"===e||"?"===e||"#"===e||"["===e||"]"===e||"@"===e||"!"===e||"$"===e||"&"===e||"("===e||")"===e||"*"===e||"+"===e||","===e||";"===e||"="===e||"'"===e}function p(e,t){var r,n="",o="";for(("number"==typeof e||"boolean"==typeof e)&&(e=e.toString()),r=0;r<e.length;r+=o.length)o=g.pctCharAt(e,r),n+=o.length>1?o:c(o)||t&&u(o)?o:g.encodeCharacter(o);return n}function h(e){return p(e,!0)}function f(e,t){this.templateText=e,this.expressions=t}function d(e){var t,r="",n="";for(t=0;t<e.length;t+=n.length)n=g.pctCharAt(e,t),r+=n.length>0?n:u(n)||c(n)?n:g.encodeCharacter(n);return r}function v(e){this.literal=d(e)}function m(e,t,r){this.templateText=e,this.operator=t,this.varspecs=r}function y(e){function t(){u={varname:n.substring(p,i),exploded:!1,maxLength:null},p=null}function r(){if(h===i)throw new Error("after a ':' you have to specify the length. position = "+i);u.maxLength=parseInt(n.substring(h,i),10),h=null}var n,o,i,a,c=[],u=null,p=null,h=null;for(n=e.substr(1,e.length-2),i=0;i<n.length;i+=a.length){if(a=g.pctCharAt(n,i),0===i){if(o=b.valueOf(a),o.symbol!==""){p=1;continue}p=0}if(null!==p){if("."===a){if(p===i)throw new Error("a varname MUST NOT start with a dot -- see position "+i);continue}if(l(a))continue;t()}if(null!==h){if(s(a))continue;r()}if(":"!==a)if("*"!==a){if(","!==a)throw new Error("illegal character '"+a+"' at position "+i);c.push(u),u=null,p=i+1}else{if(null===u)throw new Error("explode exploded at position "+i);if(u.exploded)throw new Error("explode exploded twice at position "+i);if(u.maxLength)throw new Error("an explode (*) MUST NOT follow to a prefix, see position "+i);u.exploded=!0}else{if(u.maxLength!==null)throw new Error("only one :maxLength is allowed per varspec at position "+i);h=i+1}}return null!==p&&t(),null!==h&&r(),c.push(u),new m(e,o,c)}var g=function(){function e(e){return unescape(encodeURIComponent(e))}function t(t){var r,n,o="",i=e(t);for(n=0;n<i.length;n+=1)r=i.charCodeAt(n),o+="%"+r.toString(16).toUpperCase();return o}function r(e){if(e.length<3)return!1;for(var t=0;t<e.length;t+=3)if(e.charAt(t)!=="%"||!a(e.charAt(t+1)||!a(e.charAt(t+2))))return!1;return!0}function n(e,t){var n=e.charAt(t);return"%"!==n?n:(n=e.substr(t,3),r(n)?n:"%")}return{encodeCharacter:t,decodeCharacter:decodeURIComponent,isPctEncoded:r,pctCharAt:n}}(),b=function(){function e(e){t[e]={symbol:e,separator:"?"===e?"&":""===e||"+"===e||"#"===e?",":e,named:";"===e||"&"===e||"?"===e,ifEmpty:"&"===e||"?"===e?"=":"",first:"+"===e?"":e,encode:"+"===e||"#"===e?h:p,toString:function(){return this.symbol}}}var t={};return e(""),e("+"),e("#"),e("."),e("/"),e(";"),e("?"),e("&"),{valueOf:function(e){if(t[e])return t[e];if("=,!@|".indexOf(e)>=0)throw new Error('Illegal use of reserved operator "'+e+'"');return t[""]}}}();f.prototype.toString=function(){return this.templateText},f.prototype.expand=function(e){var t,r="";for(t=0;t<this.expressions.length;t+=1)r+=this.expressions[t].expand(e);return r},v.prototype.expand=function(){return this.literal},v.prototype.toString=v.prototype.expand,m.prototype.toString=function(){return this.templateText},m.prototype.expand=function(t){function r(e,t,r){return o(t)&&(e.length>0&&(e+=","),u||(e+=f.encode(r)+","),e+=f.encode(t)),e}function i(e,t,r){return o(t)&&(e.length>0&&(e+=f.separator),e+=u?d(l.varname):f.encode(r),e+="="+f.encode(t)),e}function s(e,t,r){return o(t)&&(e.length>0&&(e+=f.separator),u||(e+=f.encode(r)+"="),e+=f.encode(t)),e}var a,l,c,u,p="",h=!0,f=this.operator;for(a=0;a<this.varspecs.length;a+=1)if(l=this.varspecs[a],c=t[l.varname],o(c))if(h?(p+=this.operator.first,h=!1):p+=this.operator.separator,u=e(c),"string"==typeof c||"number"==typeof c||"boolean"==typeof c){if(c=c.toString(),this.operator.named){if(p+=d(l.varname),""===c){p+=this.operator.ifEmpty;continue}p+="="}l.maxLength&&c.length>l.maxLength&&(c=c.substr(0,l.maxLength)),p+=this.operator.encode(c)}else{if(l.maxLength)throw new Error("Prefix modifiers are not applicable to variables that have composite values. You tried to expand "+this+" with "+JSON.stringify(c));if(l.exploded)p+=n(c,f.named?i:s,"");else{if(f.named){if(p+=d(l.varname),!o(c)){p+=this.operator.ifEmpty;continue}p+="="}p+=n(c,r,"")}}return p},f.parse=function(e){var t,r,n=[],o=null,i=0;for(t=0;t<e.length;t+=1)if(r=e.charAt(t),null===i){if(null===o)throw new Error("reached unreachable code");if("{"===r)throw new Error("brace was opened in position "+o+" and cannot be reopened in position "+t);if("}"===r){if(o+1===t)throw new Error("empty braces on position "+o);n.push(y(e.substring(o,t+1))),o=null,i=t+1}}else{if("}"===r)throw new Error("brace was closed in position "+t+" but never opened");"{"===r&&(t>i&&n.push(new v(e.substring(i,t))),i=null,o=t)}if(null!==o)throw new Error("brace was opened on position "+o+", but never closed");return i<e.length&&n.push(new v(e.substr(i))),new f(e,n)},local.http.UriTemplate=f}();var q=["head","post","put","patch","delete"],U={Json:"application/json",Html:"text/html",Xml:"text/xml",Events:"text/event-stream",Eventstream:"text/event-stream",Plain:"text/plain",Text:"text/plain"},M=["alternate","author","collection","current","describedby","first","index","item","last","latest-version","monitor","monitor-group","next","next-archive","payment","predecessor-version","prev","prev-archive","related","replies","search","self","service","successor-version","up","version-history","via","working-copy","working-copy-of"];L.UNRESOLVED=0,L.RESOLVED=1,L.FAILED=2,L.prototype.isResolved=function(){return this.resolveState===L.RESOLVED},L.prototype.isBad=function(){return this.resolveState>1},L.prototype.isRelative=function(){return!this.url&&!!this.rel},L.prototype.isAbsolute=function(){return!!this.url},L.prototype.getUrl=function(){return this.url},L.prototype.getError=function(){return this.error},L.prototype.getHost=function(){if(!this.host){if(!this.url)return null;var e=local.http.parseUri(this.url);this.host=(e.protocol||"http")+"://"+(e.authority||E())}return this.host},L.prototype.resetResolvedState=function(){this.resolveState=L.UNRESOLVED,this.error=null},L.prototype.resolve=function(e){this.error=null,this.resolveState=L.RESOLVED,this.url=e;var t=local.http.parseUri(this.url);this.host=(t.protocol||"http")+"://"+t.authority},local.http.Navigator=R,R.prototype.dispatch=function(e){if(!e||!e.method)throw"request options not provided";var t=this,r=local.promise();return(e.noresolve?local.promise(this.context.getUrl()):this.resolve({retry:e.retry,nohead:!0})).succeed(function(t){return e.url=t,local.http.dispatch(e)}).succeed(function(e){return t.context.error=null,t.context.resolveState=L.RESOLVED,t.links=e.headers.link?e.headers.link:t.links||[],e}).fail(function(e){throw e.status===404&&(t.context.error=e,t.context.resolveState=L.FAILED),e}).chain(r),r},R.prototype.subscribe=function(){return this.resolve().succeed(function(e){return local.http.subscribe(e)})},R.prototype.relation=function(e,t,r){var n=r||{};return n.title=(t||"").toLowerCase(),new R(new L(e,n),this)},R.prototype.resolve=function(e){var t=this;e=e||{};var r=e.nohead;delete e.nohead;var n=local.promise();return this.links!==null&&(this.context.isResolved()||this.context.isAbsolute()&&this.context.isBad()===!1)?n.fulfill(this.context.getUrl()):this.context.isBad()===!1||this.context.isBad()&&e.retry?(this.context.resetResolvedState(),this.parentNavigator?this.parentNavigator.__resolveChild(this,e).succeed(function(){return r?!0:t.head(null,null,null,{noresolve:!0})}).succeed(function(){return t.context.getUrl()}).chain(n):(r?local.promise(!0):this.head(null,null,null,{noresolve:!0})).succeed(function(){return t.context.getUrl()}).chain(n)):n.reject(this.context.getError()),n},R.prototype.__resolveChild=function(e,t){var r=this,n=local.promise();return this.resolve(t).then(function(){var t=r.__lookupLink(e.context);if(t)e.context.resolve(t),n.fulfill(t);else{var o=new local.http.ClientResponse(404,"link relation not found");n.reject(o),o.end()}},function(t){return e.context.error=t,e.context.resolveState=L.FAILED,n.reject(t),t}),n},R.prototype.__lookupLink=function(e){var t=local.http.lookupLink(this.links,e.rel,e.relparams.title);if(t){var r=local.http.UriTemplate.parse(t).expand(e.relparams),n=local.http.parseUri(r);return n.host||(r=this.context.getHost()+n.relative),r}return console.log("Failed to find a link to resolve context. Target link:",e.rel,e.relparams,"Navigator:",this),null},q.forEach(function(e){R.prototype[e]=function(t,r,n,o){var i=o||{};return i.headers=n||{},i.method=e,null!==t&&"null"!=typeof t&&/head/i.test(e)===!1&&(i.headers["content-type"]=r||("object"==typeof t?"application/json":"text/plain")),i.body=t,this.dispatch(i)}}),R.prototype.get=function(e,t,r){var n=r||{};return n.headers=t||{},n.method="get",n.headers.accept=e,this.dispatch(n)};for(var j in U)(function(e,t){R.prototype["get"+e]=function(e,r){return this.get(t,e,r)}})(j,U[j]);M.forEach(function(e){var t=e.replace(/-/g,"_");R.prototype[t]=function(t,r){return this.relation(e,t,r)}}),local.http.navigator=function(e,t,r){if(e instanceof R)return e;var n;return n=Array.isArray(e)?local.http.lookupLink(e,t,r):e,new R(n)}}(),typeof this.local=="undefined"&&(this.local={}),typeof this.local.client=="undefined"&&(this.local.client={}),function(){function e(e,t){for(;e;){if(t(e))return e;e=e.parentNode}return null}function t(){for(var e,r=Array.prototype.slice.call(arguments),n={};r.length;)if(e=r.shift())for(var o in e)typeof e[o]!="undefined"&&e[o]!==null&&(n[o]=typeof e[o]!="object"||Array.isArray(e[o])?e[o]:t(n[o],e[o]));return n}function r(e,t){var r=new CustomEvent("request",{bubbles:!0,cancelable:!0,detail:t});e.dispatchEvent(r)}function n(t){var r=e.thatisFormRelated(t);if(r){for(var n=0;n<r.form.length;n++)r.form[n].setAttribute("submitter",null);r.setAttribute("submitter","1")}}function o(r,n){var s={form:{},fieldset:{},elem:{}},a=null,l=null;if(r.tagName==="FIELDSET"?a=r:r.tagName!=="FORM"&&(a=e.byTag(r,"FIELDSET")),r.tagName==="FORM")l=r;else{var c=r.getAttribute("form")||(a?a.getAttribute("form"):null);c&&(l=n.querySelector("#"+c)),l||(l=e.byTag(r,"FORM"))}var u=i(r,l);l&&(s.form=o.fromForm(l,r)),a&&(s.fieldset=o.fromFormElement(a)),r.tagName==="A"?s.elem=o.fromAnchor(r):["FORM","FIELDSET"].indexOf(r.tagName)===-1&&(s.elem=o.fromFormElement(r));var p=t(s.form,s.fieldset,s.elem),h={};return h[/GET/i.test(p.method)?"query":"body"]=u,t(p,h)}function i(t,r,n){n||(n={});var o={};n.nofiles||(o.__fileReads=[]);for(var i=0;i<r.length;i++){var a=r[i];if(a.name&&e.byElement(a,t)){var l=a.getAttribute("submitter")=="1";if(a.tagName==="BUTTON")l&&(o[a.name]=a.value);else if(a.tagName==="INPUT")switch(a.type.toLowerCase()){case"button":case"submit":l&&(o[a.name]=a.value);break;case"checkbox":a.checked&&(o[a.name]=(o[a.name]||[]).concat(a.value));break;case"radio":a.getAttribute("checked")!==null&&(o[a.name]=a.value);break;case"file":if(n.nofiles)break;if(a.multiple){for(var c,i=0;c=a.files[i];i++)s(o,a,a.files[i],i);o[a.name]=[],o[a.name].length=i}else s(o,a,a.files[0]);break;default:o[a.name]=a.value}else o[a.name]=a.value}}return o}function s(e,t,r,n){var o=new FileReader;o.onloadend=a(e,t,r,n),o.readAsDataURL(r)}function a(e,t,r,n){var o=local.promise();return e.__fileReads.push(o),function(e){var i={content:e.target.result||null,name:r.name,formattr:t.name,size:r.size,type:r.type,lastModifiedDate:r.lastModifiedDate};"undefined"!=typeof n&&(i.formindex=n),o.fulfill(i)}}function l(e){var t=e.body?e.body.__fileReads:e.query?e.query.__fileReads:[];return local.promise.bundle(t).then(function(t){return e.body&&delete e.body.__fileReads,e.query&&delete e.query.__fileReads,t.forEach(function(t){typeof t.formindex!="undefined"?e.body[t.formattr][t.formindex]=t:e.body[t.formattr]=t}),e})}function c(e,t){if(!(e&&e instanceof Element))throw"Listen() requires a valid DOM element as a first parameter";e.__eventHandlers=[],t=t||{};var r;t.links!==!1&&(r={name:"click",handleEvent:p,container:e},e.addEventListener("click",r,!0),e.__eventHandlers.push(r)),t.forms!==!1&&(r={name:"submit",handleEvent:h,container:e},e.addEventListener("submit",r,!0))}function u(e){e.__eventHandlers&&(e.__eventHandlers.forEach(function(t){e.removeEventListener(t.name,t)
}),delete e.__eventHandlers);var t=e.querySelectorAll("[data-subscribe]");Array.prototype.forEach.call(t,function(e){if(e.__subscriptions){for(var t in e.__subscriptions)e.__subscriptions[t].close();delete e.__subscriptions}})}function p(e){if(e.button===0){n(e.target);var t=o.fromAnchor(e.target);if(!t||["_top","_blank"].indexOf(t.target)===-1)return t?(e.preventDefault(),e.stopPropagation(),r(e.target,t),!1):void 0}}function h(e){var t=o(e.target,this.container);if(!t||["_top","_blank"].indexOf(t.target)===-1)return t?(e.preventDefault(),e.stopPropagation(),l(t).then(function(){r(e.target,t)}),!1):void 0}function f(e,t,r){r.body=r.body||"";var n=r.headers["content-type"];if(/application\/html\-deltas\+json/.test(n))typeof r.body=="object"&&Array.isArray(r.body)?Array.isArray(r.body[0])?r.body.forEach(function(r){d(r,e,t)}):d(r.body,e,t):console.log("Improperly-formed application/html-deltas+json object",r);else{var o="";/text\/html/.test(n)?o=r.body.toString():(typeof r.body!="string"&&(o=JSON.stringify(r.body)),o=r.body.replace(/</g,"&lt;").replace(/>/g,"&gt;")),local.client.unlisten(e),e.innerHTML=o,local.env.postProcessRegion(e,t)}v(e,t),y(e,t)}function d(e,t,r){if("object"==typeof e&&Array.isArray(e)){var n,o,i,s=e.shift(),a=e.shift(),l=e;if(s&&a){var c=r.querySelectorAll(a),u=function(e){c[n].classList.add(e)},p=function(e){c[n].classList.remove(e)},h=function(e){c[n].classList.toggle(e)};for(n=0,o=c.length;o>n;n++)if(c[n]){var f=c[n];switch(s){case"replace":local.client.unlisten(f),f.innerHTML=l[0],local.env.postProcessRegion(f,r);break;case"remove":local.client.unlisten(f),f.parentNode.removeChild(f);break;case"append":f.innerHTML=f.innerHTML+l[0],local.env.postProcessRegion(f,r);break;case"prepend":f.innerHTML=l[0]+f.innerHTML,local.env.postProcessRegion(f,r);break;case"addClass":f.classList&&(l[0]||"").split(" ").forEach(u);break;case"removeClass":f.classList&&(l[0]||"").split(" ").forEach(p);break;case"toggleClass":f.classList&&(l[0]||"").split(" ").forEach(h);break;case"setAttribute":l[0]&&f.setAttribute(l[0],l[1]);break;case"navigate":i=local.env.getClientRegion(f.id),i?i.dispatchRequest(l[0]):console.log("html-delta navigate targeted non-client-region element",f,a)}}}}}function v(e,t){L.forEach(function(r){var n="on"+r,o=e.querySelectorAll("["+n+"]");Array.prototype.forEach.call(o,function(e){var o=e.getAttribute(n);e.addEventListener(r,m(o,t)),e.removeAttribute(n)})})}function m(e,n){return function(i){i.preventDefault(),i.stopPropagation();var s=o(i.currentTarget,n);s.method=e,l(s).then(function(){var n=/GET/i.test(e);n||s.body?n&&s.body&&(s.query=t(s.body,s.query),s.body={}):(s.body=s.query,s.query={}),r(i.target,s)})}}function y(e){var t=e.querySelectorAll("[data-subscribe]");Array.prototype.forEach.call(t,function(e){var t=e.dataset.subscribe.split(" "),r=t[0],n=t[1]||r;e.__subscriptions=e.__subscriptions||{};var o=e.__subscriptions[r];o||(o=e.__subscriptions[r]=local.http.subscribe({url:r}),o.on("update",g(n,e)),o.on("error",b()))})}function g(e,t){return function(){var n={method:"get",url:e,target:"_element",headers:{accept:"text/html"}};t.tagName=="FORM"&&(n.query=i(t,t,{nofiles:!0}),n.headers.accept=t.getAttribute("accept")||"text/html"),r(t,n)}}function b(){return function(e){var t=e.data;console.log("Client update stream error:",t)}}function w(e){if(this.id=e,this.context={url:"",urld:{},links:[],type:""},this.element=document.getElementById(e),!this.element)throw"Region target element not found";this.element.classList.add("client-region"),this.listenerFn=E.bind(this),this.element.addEventListener("request",this.listenerFn),local.client.listen(this.element)}function E(e){e.preventDefault(),e.stopPropagation();var t=e.detail;this.__prepareRequest(t);var r=this,n=function(n){r.__handleResponse(e,t,n)};local.http.dispatch(t,this).then(n,n)}e.byTag=function(t,r){return e(t,function(e){return e.tagName==r})},e.byClass=function(t,r){return e(t,function(e){return e.classList&&e.classList.contains(r)})},e.byElement=function(t,r){return e(t,function(e){return e===r})},e.thatisFormRelated=function(t){return e(t,function(e){return!!e.form})},o.fromAnchor=function(t){if(t=e.byTag(t,"A"),!t||!t.attributes.href||t.attributes.href.value.charAt(0)=="#")return null;var r={method:"get",url:t.attributes.href.value,target:t.getAttribute("target"),headers:{accept:t.getAttribute("type")}};return r},o.fromFormElement=function(e){var t={method:e.getAttribute("formmethod"),url:e.getAttribute("formaction"),target:e.getAttribute("formtarget"),headers:{"content-type":e.getAttribute("formenctype"),accept:e.getAttribute("formaccept")}};return t},o.fromForm=function(e,r){if(r&&!r.form)for(var n=0;n<e.length;n++){var o=e[n];if(o.getAttribute("submitter")=="1"){r=o,o.setAttribute("submitter","0");break}}var i={submitter:{},form:{}};r&&(i.submitter={method:r.getAttribute("formmethod"),url:r.getAttribute("formaction"),target:r.getAttribute("formtarget"),headers:{"content-type":r.getAttribute("formenctype"),accept:r.getAttribute("formaccept")}}),i.form={method:e.getAttribute("method"),url:e.getAttribute("action"),target:e.getAttribute("target"),headers:{"content-type":e.getAttribute("enctype")||e.enctype,accept:e.getAttribute("accept")}},e.acceptCharset&&(i.form.headers.accept=e.acceptCharset);var s=t(i.form,i.submitter);return s},local.client.findParentNode=e,local.client.extractRequest=o,local.client.extractRequestPayload=i,local.client.listen=c,local.client.unlisten=u;var L=["blur","change","click","dblclick","focus","keydown","keypress","keyup","load","mousedown","mousemove","mouseout","mouseover","mouseup","reset","select","submit","unload"];local.client.renderResponse=f,"undefined"==typeof CustomEvent&&(CustomEvent=function(e,t){var r=document.createEvent("CustomEvent");return r.initCustomEvent(e,t.bubbles,t.cancelable,t.detail),r}),local.client.Region=w,w.prototype.dispatchRequest=function(e){"string"==typeof e&&(e={method:"get",url:e,headers:{accept:"text/html"}});var t=new CustomEvent("request",{bubbles:!0,cancelable:!0,detail:e});this.element.dispatchEvent(t)},w.prototype.terminate=function(){local.client.unlisten(this.element),this.element.removeEventListener("request",this.listenerFn)},w.prototype.__prepareRequest=function(e){e.headers=e.headers||{},e.headers.accept=e.headers.accept||"text/html",e.stream=!1;var t=local.http.parseUri(e);if(!t.protocol){var r;r=e.url.length>0&&e.url.charAt(0)!="/"?this.context.urld.protocol+"://"+this.context.urld.host+this.context.urld.directory+e.url:this.context.urld.protocol+"://"+this.context.urld.host+e.url;var n=this.context.urld.host;do e.url=r,r=e.url.replace(/[^\/]+\/\.\.\//i,"");while(r!=e.url&&local.http.parseUri(r).host==n);delete e.host,delete e.path}},w.prototype.__handleResponse=function(e,t,r){r.headers=r.headers||{};var n=this.__chooseRequestTarget(e,t);if(n){var o=local.env.getClientRegion(n.id);switch(o&&o.__updateContext(t,r),r.status){case 204:break;case 205:n.tagName==="FORM"&&n.reset();break;case 303:var i={method:"get",url:r.headers.location,headers:{accept:"text/html"}};this.dispatchRequest(i);break;default:local.client.renderResponse(n,this.element,r)}}},w.prototype.__updateContext=function(e,t){var r=local.http.parseUri(e);this.context.urld=r,this.context.url=r.protocol+"://"+r.authority+r.directory,this.context.links=t.headers.link,this.context.type=t.headers["content-type"]},w.prototype.__chooseRequestTarget=function(e,t){return t.target=="_element"?e.target:document.getElementById(t.target)||this.element}}(),typeof this.local=="undefined"&&(this.local={}),typeof this.local.env=="undefined"&&(this.local.env={}),function(){(function(){function e(){return i++}function t(e,t){t=t||{},this.isLogging=t.log,this.messageListeners={},this.replyCbs={},this.messageBuffers={},e&&this.onNamedMessage("ready",e,this),this.worker=new Worker(t.bootstrapUrl||"worker.js"),r.call(this)}function r(){var e=this;this.worker.addEventListener("message",function(t){var r=t.data;if(this.isLogging&&console.log("receiving",r),r.name==="reply"){var n=e.replyCbs[r.reply_to];if(n)return n.func.call(n.context,r),delete e.replyCbs[r.reply_to],void 0}var o=e.messageListeners[r.name];if(r.name==="endMessage"){var i=r.data;o=e.messageListeners[i],e.removeAllNamedMessageListeners(i)}o&&o.forEach(function(e){e.func.call(e.context,r)})})}function n(t,r,n){var o={id:e(),reply_to:n,name:t,data:r};return o}function o(e,t,r){e.name in this.messageBuffers?this.messageBuffers[e.name].push([e,t,r]):(t&&"function"==typeof t&&(this.replyCbs[e.id]={func:t,context:r}),this.isLogging&&console.log("sending",e),this.worker.postMessage(e))}var i=1;local.env.Worker=t,t.prototype.postNamedMessage=function(e,t,r,i){var s=n(e,t);return o.call(this,s,r,i),s.id},t.prototype.postReply=function(e,t,r,i){var s="object"==typeof e?e.id:e,a=n("reply",t,s);return o.call(this,a,r,i),a.id},t.prototype.endMessage=function(e){return this.postNamedMessage("endMessage",e)},t.prototype.addNamedMessageListener=function(e,t,r){e in this.messageListeners||(this.messageListeners[e]=[]),this.messageListeners[e].push({func:t,context:r})},t.prototype.onNamedMessage=t.prototype.addNamedMessageListener,t.prototype.removeNamedMessageListener=function(e,t){if(e in this.messageListeners){var r=function(e){return e.func!=t};this.messageListeners[e]=this.messageListeners[e].filter(r),this.messageListeners[e].length===0&&delete this.messageListeners[e]}},t.prototype.removeAllNamedMessageListeners=function(e){e in this.messageListeners&&delete this.messageListeners[e]},t.prototype.bufferMessages=function(e){e in this.messageBuffers||(this.messageBuffers[e]=[])},t.prototype.releaseMessages=function(e){if(e in this.messageBuffers){var t=this.messageBuffers[e];delete this.messageBuffers[e],t.forEach(function(e){o.apply(this,e)},this)}},t.prototype.nullify=function(e){this.postNamedMessage("nullify",e)},t.prototype.importScripts=function(e,t){this.postNamedMessage("importScripts",e,t)},t.prototype.terminate=function(){var e;for(e in this.messageListeners)delete this.messageListeners[e];for(e in this.replyCbs)delete this.replyCbs[e];this.worker.terminate(),this.worker=null}})(),function(){function e(){return n++}function t(){this.config={id:e(),domain:null}}function r(e,n){e=e||{},t.call(this),this.state=r.BOOT;for(var o in e)this.config[o]=e[o];this.config.src||(this.config.src=""),this.config.srcBaseUrl||(this.config.srcBaseUrl=/^data/.test(this.config.src)===!1?this.config.src.replace(/\/[^/]+$/,"/"):""),this.config.domain||(this.config.domain="<"+this.config.src.slice(0,40)+">"),this.config.environmentHost=window.location.host,this.loaderrorCb=n,this.readyMessage=null,this.canLoadUserscript=!1,this.activeEventStreams=[],this.worker=new local.env.Worker(null,{bootstrapUrl:local.env.config.workerBootstrapUrl}),this.worker.bufferMessages("httpRequest"),this.worker.onNamedMessage("ready",this.onWorkerReady,this),this.worker.onNamedMessage("terminate",this.terminate,this),this.worker.onNamedMessage("httpRequest",this.onWorkerHttpRequest,this),this.worker.onNamedMessage("httpSubscribe",this.onWorkerHttpSubscribe,this),this.worker.onNamedMessage("log",this.onWorkerLog,this)}var n=1;local.env.Server=t,t.prototype.handleHttpRequest=function(e,t){t.writeHead(0,"server not implemented"),t.end()},t.prototype.terminate=function(){},t.prototype.getSource=function(){return this.handleHttpRequest.toString()},local.env.WorkerServer=r,r.prototype=Object.create(t.prototype),r.BOOT=0,r.READY=1,r.ACTIVE=2,r.DEAD=3,r.prototype.onWorkerReady=function(e){this.worker.nullify("XMLHttpRequest"),this.worker.nullify("Worker"),this.worker.nullify("importScripts"),this.state=r.READY,this.readyMessage=e,this.canLoadUserscript&&this.loadUserScript()},r.prototype.loadUserScript=function(){if(this.canLoadUserscript=!0,this.state==r.READY){this.worker.postReply(this.readyMessage,this.config);var e=this.config.src;e.indexOf("data:application/javascript,")===0&&(e="data:application/javacsript;base64,"+btoa(e.slice(28)));var t=this;this.worker.importScripts(e,function(e){return e.data.error?(t.loaderrorCb&&t.loaderrorCb(e.data),t.terminate(),void 0):(t.state!=r.DEAD&&(t.state=r.ACTIVE,t.worker.releaseMessages("httpRequest")),void 0)})}},r.prototype.terminate=function(){this.state=r.DEAD,this.activeEventStreams.forEach(function(e){e&&e.close()}),this.worker.terminate()},r.prototype.getSource=function(e){if(/^data/.test(this.config.src))return this.config.src.indexOf("data:application/javascript;base64,")===0?local.promise(atob(this.config.src.split(",")[1]||"")):local.promise(this.config.src.split(",")[1]||"");var t={method:"get",url:this.config.src,headers:{accept:"application/javascript"}};return local.http.dispatch(t,e).then(function(e){return e.body},function(e){return console.log("failed to retrieve worker source:",e),""})},r.prototype.onWorkerLog=function(e){console.log("["+this.config.domain+"]",e.data)},r.prototype.onWorkerHttpRequest=function(e){var t=this;e.data;var r=function(r){var n=t.worker.postReply(e,r);r.isConnOpen?(r.on("data",function(e){t.worker.postNamedMessage(n,e)}),r.on("end",function(){t.worker.endMessage(n)})):t.worker.endMessage(n)};local.http.dispatch(e.data,this).then(r,r)},r.prototype.onWorkerHttpSubscribe=function(e){var t=this,n=e.data,o=local.http.subscribe(n),i=this.activeEventStreams.push(o);o.on("error",function(){t.activeEventStreams[i]=null}),this.worker.onNamedMessage(e.id,function(e){if("endMessage"==e)o.close();else{var n=e.data,i=t.worker.postReply(e);o.on(n,function(e){t.state!=r.DEAD&&t.worker.postNamedMessage(i,e)})}})},r.prototype.handleHttpRequest=function(e,t){var r=this.worker,n=r.postNamedMessage("httpRequest",e,function(e){if(!e.data)throw"Invalid httpRequest reply to document from worker";t.writeHead(e.data.status,e.data.reason,e.data.headers),typeof e.data.body!="undefined"&&e.data.body!==null&&t.write(e.data.body),r.onNamedMessage(e.id,function(e){e.name==="endMessage"?t.end():t.write(e.data)})},this);e.stream&&t.clientResponse.on("close",function(){r.endMessage(n)})}}(),local.env.config={workerBootstrapUrl:"worker.min.js"},local.env.servers={},local.env.clientRegions={},local.env.numServers=0,local.env.numClientRegions=0,local.env.addServer=function(e,t){return t.config.domain=e,local.env.servers[e]=t,local.env.numServers++,t.loadUserScript&&t.loadUserScript(),local.http.registerLocal(e,t.handleHttpRequest,t),t},local.env.killServer=function(e){var t=local.env.servers[e];t&&(local.http.unregisterLocal(e),t.terminate(),delete local.env.servers[e],local.env.numServers--)},local.env.getServer=function(e){return local.env.servers[e]},local.env.listFilteredServers=function(e){var t={};for(var r in local.env.servers)e(local.env.servers[r],r)&&(t[r]=local.env.servers[r]);return t},local.env.addClientRegion=function(e){var t;return"object"==typeof e?t=e.id:(t=e,e=new local.client.Region(t)),local.env.clientRegions[e.id]=e,local.env.numClientRegions++,e},local.env.removeClientRegion=function(e){local.env.clientRegions[e]&&(local.env.clientRegions[e].terminate(),delete local.env.clientRegions[e],local.env.numClientRegions--)},local.env.getClientRegion=function(e){return local.env.clientRegions[e]};var e,t=local.http.dispatch;local.http.dispatch=function(r,n){if(r.headers=r.headers||{},r.query=r.query||{},r.method=r.method?r.method.toUpperCase():"GET",r.url||(r.url=local.http.joinUrl(r.host,r.path)),r.urld||(r.urld=local.http.parseUri(r.url)),r.urld.query){var o=local.http.contentTypes.deserialize(r.urld.query,"application/x-www-form-urlencoded");for(var i in o)r.query[i]=o[i];delete r.urld.query,r.urld.relative=r.urld.path}var s=e.call(this,r,n,t);if(s instanceof local.Promise)return s;if(s){if(!(s instanceof local.http.ClientResponse))if("object"==typeof s){var a=new local.http.ClientResponse(s.status,s.reason);a.headers=s.headers,a.end(s.body),s=a}else s=new local.http.ClientResponse(0,s.toString()),s.end()}else s=new local.http.ClientResponse(0,"Environment did not correctly dispatch the request"),s.end();var l=local.promise();return s.status>=400||s.status===0?l.reject(s):l.fulfill(s),l},e=function(e,t,r){return r(e)},local.env.setDispatchWrapper=function(t){e=t};var r=function(){};local.env.postProcessRegion=function(e,t){return r(e,t)},local.env.setRegionPostProcessor=function(e){r=e}}();